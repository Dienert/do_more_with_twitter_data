<!DOCTYPE html>


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Do More with Twitter Data &#8212; Do more with Twitter data 0.1 documentation</title>
    
    <link rel="stylesheet" href="_static/bootstrap-sphinx.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    './',
        VERSION:     '0.1',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true,
        SOURCELINK_SUFFIX: '.txt'
      };
    </script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <script type="text/javascript" src="_static/js/jquery-1.11.0.min.js"></script>
    <script type="text/javascript" src="_static/js/jquery-fix.js"></script>
    <script type="text/javascript" src="_static/bootstrap-3.3.7/js/bootstrap.min.js"></script>
    <script type="text/javascript" src="_static/bootstrap-sphinx.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
<meta charset='utf-8'>
<meta http-equiv='X-UA-Compatible' content='IE=edge,chrome=1'>
<meta name='viewport' content='width=device-width, initial-scale=1.0, maximum-scale=1'>
<meta name="apple-mobile-web-app-capable" content="yes">

  </head>
  <body role="document">

  <div id="navbar" class="navbar navbar-inverse navbar-default navbar-fixed-top">
    <div class="container">
      <div class="navbar-header">
        <!-- .btn-navbar is used as the toggle for collapsed navbar content -->
        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".nav-collapse">
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
        <a class="navbar-brand" href="index.html">
          Do more with Twitter data</a>
        <span class="navbar-text navbar-version pull-left"><b>0.1</b></span>
      </div>

        <div class="collapse navbar-collapse nav-collapse">
          <ul class="nav navbar-nav">
            
                <li><a href="https://github.com/twitterdev/do_more_with_twitter_data">Github</a></li>
            
            
              <li class="dropdown globaltoc-container">
  <a role="button"
     id="dLabelGlobalToc"
     data-toggle="dropdown"
     data-target="#"
     href="index.html">Site <b class="caret"></b></a>
  <ul class="dropdown-menu globaltoc"
      role="menu"
      aria-labelledby="dLabelGlobalToc"></ul>
</li>
              
                <li class="dropdown">
  <a role="button"
     id="dLabelLocalToc"
     data-toggle="dropdown"
     data-target="#"
     href="#">Page <b class="caret"></b></a>
  <ul class="dropdown-menu localtoc"
      role="menu"
      aria-labelledby="dLabelLocalToc"><ul>
<li><a class="reference internal" href="#">Do More with Twitter Data</a><ul>
<li><a class="reference internal" href="#data-collection-filtering-and-parsing">Data Collection, Filtering, and Parsing</a><ul>
<li><a class="reference internal" href="#caveat"><em>Caveat</em></a></li>
</ul>
</li>
<li><a class="reference internal" href="#using-twitter-data-to-answer-a-question">Using Twitter data to answer a question</a></li>
<li><a class="reference internal" href="#why-do-we-want-to-know-this"><em>Why</em> do we want to know this?</a></li>
<li><a class="reference internal" href="#what-are-we-interested-in"><em>What</em> are we interested in?</a></li>
<li><a class="reference internal" href="#when-is-this-information-relevant"><em>When</em> is this information relevant?</a></li>
<li><a class="reference internal" href="#who-are-we-interested-in"><em>Who</em> are we interested in?</a></li>
<li><a class="reference internal" href="#where-are-they"><em>Where</em> are they?</a></li>
</ul>
</li>
<li><a class="reference internal" href="#consume-tweet-data-the-twitter-search-apis">1. Consume Tweet data: the Twitter Search APIs</a><ul>
<li><a class="reference internal" href="#twitter-search-apis-query-language">Twitter Search APIs query language</a></li>
<li><a class="reference internal" href="#consuming-tweets">Consuming Tweets</a></li>
<li><a class="reference internal" href="#running-this-notebook">Running This Notebook</a></li>
<li><a class="reference internal" href="#parse-twitter-data">2. Parse Twitter data</a></li>
<li><a class="reference internal" href="#the-nitty-gritty-tweet-payloads">The nitty gritty: Tweet payloads</a></li>
<li><a class="reference internal" href="#tweet-parser">tweet_parser</a></li>
<li><a class="reference internal" href="#before-you-read-these-tweets">Before you read these Tweets</a></li>
<li><a class="reference internal" href="#describe-your-data">3. Describe your data</a></li>
<li><a class="reference internal" href="#how-are-people-tweeting">How are people Tweeting?</a></li>
<li><a class="reference internal" href="#common-words">Common words</a></li>
<li><a class="reference internal" href="#who-is-tweeting-who-is-speaking">Who is Tweeting? Who is speaking?</a></li>
<li><a class="reference internal" href="#time-series-plot">Time series plot</a></li>
<li><a class="reference internal" href="#iterate">3. Iterate</a></li>
<li><a class="reference internal" href="#now-that-we-understand-what-we-re-matching-on">Now that we understand what we&#8217;re matching on</a></li>
<li><a class="reference internal" href="#look-at-that-regular-timeseries">Look at that regular timeseries!</a></li>
<li><a class="reference internal" href="#frequent-terms-vs-frequent-n-grams">Frequent terms vs frequent &#8220;n-grams&#8221;</a></li>
<li><a class="reference internal" href="#look-how-much-irrelevant-data-we-ve-eliminated">Look how much irrelevant data we&#8217;ve eliminated</a></li>
<li><a class="reference internal" href="#pulling-our-dataset">Pulling our dataset</a></li>
<li><a class="reference internal" href="#save-tweets-to-a-file-and-stream-them-into-memory">Save Tweets to a file, and stream them into memory</a></li>
</ul>
</li>
<li><a class="reference internal" href="#conclusion">Conclusion</a></li>
</ul>
</ul>
</li>
              
            
            
              
                
              
            
            
            
            
          </ul>

          
            
<form class="navbar-form navbar-right" action="search.html" method="get">
 <div class="form-group">
  <input type="text" name="q" class="form-control" placeholder="Search" />
 </div>
  <input type="hidden" name="check_keywords" value="yes" />
  <input type="hidden" name="area" value="default" />
</form>
          
        </div>
    </div>
  </div>

<div class="container">
  <div class="row">
    <div class="col-md-12 content">
      
  <div class="section" id="do-more-with-twitter-data">
<span id="finding-the-right-data"></span><h1>Do More with Twitter Data<a class="headerlink" href="#do-more-with-twitter-data" title="Permalink to this headline">¶</a></h1>
<p>Twitter is what&#8217;s happening and what people are talking about right now,
with hundreds of millions of Tweets sent each day. We&#8217;re a group of data
scientists on the Twitter Data team who are helping people do more with
this vast amount of data in less time. In this spirit, we are starting a
series of tutorials that aim to help people work with Twitter data
effectively. Each of the posts in this series centers around a real-life
example project and provides MIT-licensed code that you can use to
bootstrap your projects with our enterprise and premium API products. We
hope this series is fruitful for you and we are excited to see what
you&#8217;ll build.</p>
<div class="section" id="data-collection-filtering-and-parsing">
<h2>Data Collection, Filtering, and Parsing<a class="headerlink" href="#data-collection-filtering-and-parsing" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li>By Fiona Pigott,
&#64;<a class="reference external" href="https://twitter.com/notFromShrek">notFromShrek</a>, Data
Scientist at Twitter, Jan 2018</li>
</ul>
<p>In this inaugural post, we&#8217;ll introduce data collection, filtering,
parsing, and summarizing. We want to be able to give readers an easy way
to spin up on the Twitter Search APIs, tips around quickly examining
data, and guidelines around one of the most difficult and most
overlooked Twitter data challenges: making sure you get the right Tweets
for the job.</p>
<div class="section" id="caveat">
<h3><em>Caveat</em><a class="headerlink" href="#caveat" title="Permalink to this headline">¶</a></h3>
<p>This post is not meant to be a tutorial in Python or the PyData
ecosystem and assumes that readers have a reasonable amount of technical
sophistication, such that they could find the right Tweets for their use
case in any language or framework. This tutorial uses Python because our
group makes heavy use of the PyData stack (python, pandas, numpy, etc.),
but a technical user could follow along in a programming language of
their choice.</p>
</div>
</div>
<div class="section" id="using-twitter-data-to-answer-a-question">
<h2>Using Twitter data to answer a question<a class="headerlink" href="#using-twitter-data-to-answer-a-question" title="Permalink to this headline">¶</a></h2>
<p>Typically you will start with a very high-level question that requires
refinement to understand what data might be useful to you in answering
that question. For this post, let&#8217;s start with a broad question:</p>
<p>&#8220;<strong>I want to understand airline customers while they fly.</strong>&#8220;</p>
<p>We&#8217;ll begin our refinement process from here.</p>
</div>
<div class="section" id="why-do-we-want-to-know-this">
<h2><em>Why</em> do we want to know this?<a class="headerlink" href="#why-do-we-want-to-know-this" title="Permalink to this headline">¶</a></h2>
<p>Understanding the business need behind a question is paramount. Use it
to understand where it is important to spend extra time to be exact, and
where an estimation will suffice. Also use &#8220;why&#8221; to understand when the
analysis needs to be complete&#8211;the best analysis is not useful if it is
finished a month after a decision is made and presented.</p>
</div>
<div class="section" id="what-are-we-interested-in">
<h2><em>What</em> are we interested in?<a class="headerlink" href="#what-are-we-interested-in" title="Permalink to this headline">¶</a></h2>
<p>Use this question to help define where to begin with the analysis and
which data to pull. To understand airline customers&#8217; behavior while they
are flying and getting ready to fly, we are interested in people
actually in an airport or on a plane, but we are not interested in
people simply talking about airlines (sharing news stories about an
airline, for instance).</p>
</div>
<div class="section" id="when-is-this-information-relevant">
<h2><em>When</em> is this information relevant?<a class="headerlink" href="#when-is-this-information-relevant" title="Permalink to this headline">¶</a></h2>
<p>Deciding on a relevant timeframe is all about the business use case: if
you&#8217;re tracking a trend over a long period of time, you may need years
of data; if you&#8217;re looking at the audience of a single TV premier, a few
days of data may be enough.</p>
<p>In the case of our air travel question, we&#8217;re only interested in any
given Twitter user in the few hours around their plane flight, so we
don&#8217;t necessarily need to track Tweets over a long period of time. We
do, however, want to get enough of a sample to make generalizations
about how people Tweet before and after flights, so we should make sure
to collect enough data over a long enough period of time to examine
multiple flights.</p>
</div>
<div class="section" id="who-are-we-interested-in">
<h2><em>Who</em> are we interested in?<a class="headerlink" href="#who-are-we-interested-in" title="Permalink to this headline">¶</a></h2>
<p>Using simple rule filters like country and language can go a long way
towards helping us analyze Tweets from the right people. In this case,
we&#8217;re interested in people from all demographics, as long as they are
<em>also</em> passengers on an airline. We can likely identify those people
through their language (&#8220;About to take off, headed home to Boulder!&#8221;),
their granular geo-tagged location, or Twitter place (&#8220;Denver
International Airport&#8221;).</p>
</div>
<div class="section" id="where-are-they">
<h2><em>Where</em> are they?<a class="headerlink" href="#where-are-they" title="Permalink to this headline">¶</a></h2>
<p>We can use Twitter&#8217;s geo data and enrichments to make sure that our
users are in relevant locations, if that is important to the question.
Another way to approximate a user&#8217;s location might be the language they
speak, or even the time that they are Tweeting (if you&#8217;re collecting
Tweets at 2AM PST, don&#8217;t expect to see a lot of content from
California).</p>
<p>Remember, selecting only users for whom we have a very granular
locations (like a geo-tag near an airport) means that we only get a
sample of users. For studies where we want to know generally what people
are talking about that might not be a problem, but it isn&#8217;t as effective
for studies where we want an exact count. Keep those trade-offs in mind
when designing a data query.</p>
<hr class="docutils" />
<p>Once we have a good understanding of our question, the next steps are to
figure out how to get to the answer using Twitter data. We&#8217;ll have to
get the right data, understand it, and filter out any irrelevant data.</p>
<p><strong>Steps to get to an answer</strong></p>
<ol class="arabic simple">
<li>Consume Tweet data<ul>
<li>We need to get Tweets to analyze them. We&#8217;ll walk through using
the Python client for the Twitter Search API right inside this
notebook. All you need is an account.</li>
</ul>
</li>
<li>Parse Twitter data<ul>
<li>You can&#8217;t analyze what you can&#8217;t load. Understand the structure of
the data, and get the pieces that are important to your analysis.</li>
</ul>
</li>
<li>Describe Twitter data<ul>
<li>Descriptive statistics go a long way. What are the most popular
hashtags? When are people Tweeting about these topics? Where is
noise coming from? Are there specific URLs, hashtags, or
&#64;-mentions being shared that <em>aren&#8217;t</em> relevant to your analysis?</li>
</ul>
</li>
<li>Iterate on your search terms to filter the data<ul>
<li>We can&#8217;t simply ask for every Tweet. A thoughtful analysis needs
to work within the bounds of the Twitter data APIs to filter and
retrieve the right data for the job&#8211;and for your data budget. Now
that you know how to quickly edit rules to retrieve small
quantities of data, as well as parse and describe a set of Tweets,
it&#8217;s time to iterate on filters to retrieve the data that is
relevant to your question (and not pay for data that isn&#8217;t).</li>
</ul>
</li>
</ol>
</div>
</div>
<hr class="docutils" />
<div class="section" id="consume-tweet-data-the-twitter-search-apis">
<h1>1. Consume Tweet data: the Twitter Search APIs<a class="headerlink" href="#consume-tweet-data-the-twitter-search-apis" title="Permalink to this headline">¶</a></h1>
<div class="section" id="twitter-search-apis-query-language">
<h2>Twitter Search APIs query language<a class="headerlink" href="#twitter-search-apis-query-language" title="Permalink to this headline">¶</a></h2>
<p>In order to pull Tweets from the Search APIs, you will first have to
understand how to write a search query in Twitter&#8217;s premium / enterprise
search API&#8217;s query language. The most important basics are these:</p>
<ul class="simple">
<li>Operator: Anything that can select or &#8220;match&#8221; a Tweet. One type of
operator is a simple token match. A token match operator is simply
the word, e.g. <code class="docutils literal"><span class="pre">cat</span></code>, and matches when that word occurs within the
text of the Tweet. Token matches always disregard case.</li>
<li>Logical &#8220;and&#8221;: words (tokens) joined by a <code class="docutils literal"><span class="pre">space</span></code> are treated as
queries and-ed together. For instance, the query &#8220;<code class="docutils literal"><span class="pre">cat</span> <span class="pre">dog</span></code>&#8221; would
search for Tweets with both <code class="docutils literal"><span class="pre">cat</span></code> and <code class="docutils literal"><span class="pre">dog</span></code> somewhere in the text
of the Tweet.</li>
<li>Logical &#8220;or&#8221;: the operator &#8220;<code class="docutils literal"><span class="pre">OR</span></code>&#8221; (capitalization is important
here) between two tokens means that your rule will match on either
term (without needing both to be present). The rule &#8220;<code class="docutils literal"><span class="pre">cat</span> <span class="pre">OR</span> <span class="pre">dog</span></code>&#8221;
will match on a Tweet with <em>either</em> &#8220;<code class="docutils literal"><span class="pre">cat</span></code>&#8221; or &#8220;<code class="docutils literal"><span class="pre">dog</span></code>&#8221; in the
Tweet text.</li>
<li>Grouping: use parentheses <code class="docutils literal"><span class="pre">()</span></code> to group operators together. In the
query-language order of operations, &#8220;and&#8221; (<code class="docutils literal"><span class="pre">_</span></code>) is applied before
&#8220;or&#8221; (<code class="docutils literal"><span class="pre">OR</span></code>), so use parentheses to make your groups explicit.
&#8220;<code class="docutils literal"><span class="pre">cat</span> <span class="pre">dog</span> <span class="pre">OR</span> <span class="pre">bunny</span></code>&#8221; is different from &#8220;<code class="docutils literal"><span class="pre">cat</span> <span class="pre">(dog</span> <span class="pre">OR</span> <span class="pre">bunny)</span></code>&#8221;
(can you see why?).</li>
<li>Negation: use the operator &#8220;<code class="docutils literal"><span class="pre">-</span></code>&#8221; to negate operators (such as terms
that you definitely <em>don&#8217;t</em> want in your dataset). You might search
for Tweets about cats and <em>not</em> about dogs with this type of query
&#8220;<code class="docutils literal"><span class="pre">cat</span> <span class="pre">-dog</span></code>&#8221;.</li>
</ul>
<p>Detailed information on operators can be found
<a class="reference external" href="https://developer.twitter.com/en/docs/tweets/search/guides/premium-operators">here</a>.
We&#8217;ll introduce and use some more advanced operators later.</p>
<div class="line-block">
<div class="line"><strong>Caveat</strong></div>
<div class="line">When using any rule operators, you need to be careful to understand
which parts of a field a rule is matching on. On twitter.com a Tweet
seems like a simple thing, but a <a class="reference external" href="https://developer.twitter.com/en/docs/tweets/data-dictionary/overview/intro-to-tweet-json">Twitter data
payload</a>
can have more than 100 fields, and different operators match on
different fields. For this reason, it&#8217;s important to make sure that
you read the documentation around each operator and test your rules to
be sure that they are behaving as you expect.</div>
<div class="line">One example: &#8220;<code class="docutils literal"><span class="pre">cat</span></code>&#8221; (the token match operator) will only match text
that the user typed out for that Tweet (it won&#8217;t for instance, match
the word &#8220;<code class="docutils literal"><span class="pre">cat</span></code>&#8221; in the users&#8217;s name or bio).</div>
</div>
</div>
<div class="section" id="consuming-tweets">
<h2>Consuming Tweets<a class="headerlink" href="#consuming-tweets" title="Permalink to this headline">¶</a></h2>
<p>In order to Search for Tweets, we&#8217;re going to use Twitter&#8217;s
<a class="reference external" href="https://developer.twitter.com/en/docs/tweets/search/overview/full-archive-search">enterprise-grade Twitter search
tool</a>.
This tools allows a user to make a request for Tweets by specifying a
rule (more on that in a minute) that matches some Tweets and retrieve
results. This tutorial is also compatible with the 30-day search API,
though you will have to change some of the dates for searching due to
the 30-day historic limitation.</p>
<div class="line-block">
<div class="line"><strong>Requesting some Tweets</strong></div>
<div class="line">In order to search for Tweets, we have to understand specifically how
Twitter&#8217;s search rules work. We&#8217;ll outline a few simple rules, and
we&#8217;ll talk more about details later when we iterate on our rules.</div>
</div>
<div class="line-block">
<div class="line"><strong>Time window for search</strong></div>
<div class="line">Look for Tweets within a certain time window by specifying the time
window in minute granularity.</div>
</div>
<div class="line-block">
<div class="line"><strong>Search rules are simple, boolean, token matches</strong></div>
<div class="line">Tweets are tokenized on spaces and punctuation, and those tokens are
matched to a rule. Let&#8217;s look at a simple example:</div>
<div class="line">&gt; <strong>Tweet</strong>:
<code class="docutils literal"><span class="pre">&quot;Boarding</span> <span class="pre">the</span> <span class="pre">plane</span> <span class="pre">to</span> <span class="pre">fly</span> <span class="pre">to</span> <span class="pre">Tokyo</span> <span class="pre">in</span> <span class="pre">a</span> <span class="pre">few</span> <span class="pre">hours!</span> <span class="pre">So</span> <span class="pre">excited!&quot;</span></code></div>
<div class="line">&gt; <strong>Tokens</strong> (capitalization is ignored):
<code class="docutils literal"><span class="pre">&quot;boarding&quot;,</span> <span class="pre">&quot;the&quot;,</span> <span class="pre">&quot;plane&quot;,</span> <span class="pre">&quot;to&quot;,</span> <span class="pre">&quot;fly&quot;,</span> <span class="pre">&quot;to&quot;,</span> <span class="pre">&quot;tokyo&quot;,</span> <span class="pre">&quot;in&quot;,</span> <span class="pre">&quot;a&quot;,</span> <span class="pre">&quot;few&quot;,</span> <span class="pre">&quot;hours&quot;,</span> <span class="pre">&quot;so,</span> <span class="pre">&quot;excited&quot;</span></code></div>
</div>
<p>A rule that collected this Tweet might have been <code class="docutils literal"><span class="pre">&quot;plane&quot;</span></code> (because
the exact token <code class="docutils literal"><span class="pre">&quot;plane&quot;</span></code> is included in the token list). You should
note that these matches rely on complete tokens: this Tweet would
<strong>not</strong> match if our rule was <code class="docutils literal"><span class="pre">&quot;airplane&quot;</span></code>.</p>
<div class="line-block">
<div class="line"><strong>You can search for more than one token in a rule</strong></div>
<div class="line">A search for Tweets about flying on planes might include any Tweet
with the word <code class="docutils literal"><span class="pre">&quot;airplane&quot;</span></code> <em>or</em> the word <code class="docutils literal"><span class="pre">&quot;plane&quot;</span></code> <em>or</em> the word
<code class="docutils literal"><span class="pre">&quot;flying&quot;</span></code> to get all of the relevant Tweets. In a single rule, use
the operator <code class="docutils literal"><span class="pre">OR</span></code> (capitalization is important here) to search for
<em>any</em> of a set of keywords.</div>
<div class="line">&gt; <code class="docutils literal"><span class="pre">&quot;airplane</span> <span class="pre">OR</span> <span class="pre">plane</span> <span class="pre">OR</span> <span class="pre">flying&quot;</span></code></div>
</div>
<div class="line-block">
<div class="line"><strong>You can combine criteria using *and* logic, and combine tokens into
phrases using quotation marks</strong></div>
<div class="line">Maybe you want the to find Tweet that include the word <code class="docutils literal"><span class="pre">&quot;flying&quot;</span></code>
and the word <code class="docutils literal"><span class="pre">&quot;plane&quot;</span></code> but only when they appear together. Here, you
would want to use Boolean <code class="docutils literal"><span class="pre">AND</span></code> logic to combine tokens into a
single rule. In the syntax of Twitter&#8217;s Search API, <code class="docutils literal"><span class="pre">AND</span></code> is simply
represented by a space. &gt; <strong>rule</strong>: <code class="docutils literal"><span class="pre">flying</span> <span class="pre">plane</span></code></div>
<div class="line">&gt; <strong>match</strong>: <code class="docutils literal"><span class="pre">&quot;I'm</span> <span class="pre">flying</span> <span class="pre">in</span> <span class="pre">a</span> <span class="pre">plane!&quot;</span></code></div>
<div class="line">&gt; <strong>no match</strong>: <code class="docutils literal"><span class="pre">&quot;I'm</span> <span class="pre">flying!&quot;</span></code> or <code class="docutils literal"><span class="pre">&quot;I'm</span> <span class="pre">in</span> <span class="pre">a</span> <span class="pre">plane!&quot;</span></code></div>
</div>
<div class="line-block">
<div class="line">You can also look for specific phrases (combinations of tokens) using
quotation marks. Use <code class="docutils literal"><span class="pre">&quot;</span></code> to combine tokens and look for them in a
specific phrase. &gt; <strong>rule</strong>: <code class="docutils literal"><span class="pre">&quot;air</span> <span class="pre">travel&quot;</span></code></div>
<div class="line">&gt; <strong>match</strong>: <code class="docutils literal"><span class="pre">&quot;Air</span> <span class="pre">travel</span> <span class="pre">is</span> <span class="pre">great&quot;</span></code></div>
<div class="line">&gt; <strong>no match</strong>: <code class="docutils literal"><span class="pre">&quot;Travel</span> <span class="pre">by</span> <span class="pre">air</span> <span class="pre">is</span> <span class="pre">great&quot;</span></code> or
<code class="docutils literal"><span class="pre">&quot;Traveling</span> <span class="pre">in</span> <span class="pre">an</span> <span class="pre">airplane&quot;</span></code></div>
</div>
<div class="line-block">
<div class="line"><strong>You can exclude certain tokens that are irrelevant to your
analysis</strong></div>
<div class="line">Keep in mind that tokens do not exactly map to meaning (especially on
a colloquial platform like Twitter). If you are looking for Tweets
about flying (on an airplane), and you submit the rule <code class="docutils literal"><span class="pre">&quot;flying&quot;</span></code>,
<code class="docutils literal"><span class="pre">&quot;I</span> <span class="pre">don't</span> <span class="pre">give</span> <span class="pre">a</span> <span class="pre">flying</span> <span class="pre">f**k</span> <span class="pre">what</span> <span class="pre">you</span> <span class="pre">do.&quot;</span></code> would match your rule
(true story: I&#8217;ve had to exclude the phrase <code class="docutils literal"><span class="pre">&quot;flying</span> <span class="pre">f**k&quot;</span></code> from
this analysis 😳).</div>
<div class="line">Use a &#8220;<code class="docutils literal"><span class="pre">-</span></code>&#8221; to exclude, and use parentheses to group together
logical clauses: &gt; <code class="docutils literal"><span class="pre">&quot;(airplane</span> <span class="pre">OR</span> <span class="pre">plane</span> <span class="pre">OR</span> <span class="pre">flying)</span> <span class="pre">-fuck&quot;</span></code></div>
</div>
<p>This isn&#8217;t a comprehensive guide, and more clarification can be found in
our
<a class="reference external" href="http://support.gnip.com/apis/search_api2.0/rules.html">documentation</a>.</p>
<div class="line-block">
<div class="line"><strong>Getting the results</strong></div>
<div class="line">Twitter&#8217;s Search APIs return results in <em>pages</em>, with up to 500 Tweets
per page for paid tiers. For users in a sandbox environment, you can
receive a maximum of 100 Tweets per call. For a very low-volume
search, you might only need one page to retrieve all of the results.
For a high-volume search, you can choose to make multiple API call to
receive multiple pages of results.</div>
</div>
<div class="line-block">
<div class="line"><strong>Python client</strong></div>
<div class="line">Consuming data from Twitter APIs directly into an environment where we
can analyze them is important for fast iteration on queries. The data
science team has created some Python libraries that make it easy to
consume data from Twitter&#8217;s Search APIs directly into this notebook.</div>
</div>
<p>This package can be found at
<a class="reference external" href="https://github.com/twitterdev/search-tweets-python">https://github.com/twitterdev/search-tweets-python</a> and implements a
Python wrapper to: - Create appropriately formatted rule payloads (date
and rule query parameters) - Make requests of the API - Gracefully
handle pagination of Search APIs results (be aware&#8211;the tool can make
multiple API calls, so but sure to set the <code class="docutils literal"><span class="pre">max_tweets</span></code> parameter,
which we&#8217;ll point out) - Load the resultant Tweet text data as Python
objects</p>
</div>
<div class="section" id="running-this-notebook">
<h2>Running This Notebook<a class="headerlink" href="#running-this-notebook" title="Permalink to this headline">¶</a></h2>
<p>If you want to run this notebook, it is hosted
<a class="reference external" href="https://github.com/twitterdev/do_more_with_twitter_data">here</a>.
Clone this repo and you&#8217;ll see this notebook in the
<code class="docutils literal"><span class="pre">examples/finding_the_right_data</span></code> directory. Please see the
accompanying <code class="docutils literal"><span class="pre">README.md</span></code> file for full instructions. We&#8217;ve provided
both a pip-ready <code class="docutils literal"><span class="pre">finding_the_right_data_requirements.txt</span></code> file and a
conda environment file, <code class="docutils literal"><span class="pre">finding_the_right_data_conda_env.yml</span></code> that
allows an easy virtual environment for this example. This example
assumes Python 3.6.</p>
<p><strong>Credentials</strong></p>
<p>Please go ahead and make a YAML file named <code class="docutils literal"><span class="pre">.twitter_keys.yaml</span></code> in
your home directory.</p>
<p>For premium customers, the simplest credential file should look like
this:</p>
<div class="code yaml highlight-default"><div class="highlight"><pre><span></span><span class="n">search_tweets_api</span><span class="p">:</span>
  <span class="n">account_type</span><span class="p">:</span> <span class="n">premium</span>
  <span class="n">endpoint</span><span class="p">:</span> <span class="o">&lt;</span><span class="n">FULL_URL_OF_ENDPOINT</span><span class="o">&gt;</span>
  <span class="n">consumer_key</span><span class="p">:</span> <span class="o">&lt;</span><span class="n">CONSUMER_KEY</span><span class="o">&gt;</span>
  <span class="n">consumer_secret</span><span class="p">:</span> <span class="o">&lt;</span><span class="n">CONSUMER_SECRET</span><span class="o">&gt;</span>
</pre></div>
</div>
<p>For enterprise customers, the simplest credential file should look like
this:</p>
<div class="code yaml highlight-default"><div class="highlight"><pre><span></span><span class="n">search_tweets_api</span><span class="p">:</span>
  <span class="n">account_type</span><span class="p">:</span> <span class="n">enterprise</span>
  <span class="n">endpoint</span><span class="p">:</span> <span class="o">&lt;</span><span class="n">FULL_URL_OF_ENDPOINT</span><span class="o">&gt;</span>
  <span class="n">username</span><span class="p">:</span> <span class="o">&lt;</span><span class="n">USERNAME</span><span class="o">&gt;</span>
  <span class="n">password</span><span class="p">:</span> <span class="o">&lt;</span><span class="n">PW</span><span class="o">&gt;</span>
</pre></div>
</div>
<p>The rest of the example will assume <code class="docutils literal"><span class="pre">~/.twitter_keys.yaml</span></code> exists,
though you can specify your connection information directing in the
notebook or using an environment variable if you want. For more
information, please see the <code class="docutils literal"><span class="pre">searchtweets</span></code> <a class="reference external" href="https://twitterdev.github.io/search-tweets-python/#credential-handling">section on credential
handling</a>.</p>
<p>The <code class="docutils literal"><span class="pre">load_credentials</span></code> function parses this file and we&#8217;ll save the
<code class="docutils literal"><span class="pre">search_args</span></code> variable for use throughout the session.</p>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">tweet_parser.tweet</span> <span class="k">import</span> <span class="n">Tweet</span>
<span class="kn">from</span> <span class="nn">searchtweets</span> <span class="k">import</span> <span class="p">(</span><span class="n">ResultStream</span><span class="p">,</span>
                           <span class="n">collect_results</span><span class="p">,</span>
                           <span class="n">gen_rule_payload</span><span class="p">,</span>
                           <span class="n">load_credentials</span><span class="p">)</span>

<span class="n">search_args</span> <span class="o">=</span> <span class="n">load_credentials</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="s2">&quot;~/.twitter_keys.yaml&quot;</span><span class="p">,</span>
                               <span class="n">account_type</span><span class="o">=</span><span class="s2">&quot;enterprise&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>In the following cells, we&#8217;ll define our rule and rule payloads, then
use the <code class="docutils literal"><span class="pre">collect_results</span></code> method to get our tweets.</p>
<p>First - it is often convenient to assign a rule to a variable. Rules are
strings and can be simple strings, e.g., <code class="docutils literal"><span class="pre">&quot;(flying</span> <span class="pre">OR</span> <span class="pre">plane)&quot;</span></code> or be
literal blocks, which can be easier to read for long rules:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">(flying</span>
<span class="sd"> OR plane</span>
<span class="sd"> OR landed)</span>
<span class="sd">&quot;&quot;&quot;</span>
</pre></div>
</div>
<p>The remaining functions will parse newlines correctly.</p>
<p>Below, we&#8217;ll start with a simple rule.</p>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="n">_rule_a</span> <span class="o">=</span> <span class="s2">&quot;(flying OR plane OR landed OR airport OR takeoff)&quot;</span>
</pre></div>
</div>
<p>The function, <code class="docutils literal"><span class="pre">gen_rule_payload</span></code>, will generate the JSON used to make
requests to the search endpoint. Its full API doc lives
<a class="reference external" href="https://twitterdev.github.io/twitter_search_api/twittersearch.html#twittersearch.api_utils.gen_rule_payload">here</a>,
but it has several main parameters:</p>
<ol class="arabic simple">
<li><code class="docutils literal"><span class="pre">pt_rule</span></code> (or the first positional arg) – The string version of a
powertrack rule</li>
<li><code class="docutils literal"><span class="pre">results_per_call</span></code> – number of tweets or counts returned per API.
Defaults to 500 to reduce API call usage, but you can change it as
needed. It can range from 100-500.</li>
<li><code class="docutils literal"><span class="pre">from_date</span></code> – Date the starting time of your search.</li>
<li><code class="docutils literal"><span class="pre">to_date</span></code> – Date for the end time of your search.</li>
<li><code class="docutils literal"><span class="pre">count_bucket</span></code> – If using the counts api endpoint, this will define
the count bucket for which tweets are aggregated. This must be set if
you want to use the Counts API.</li>
</ol>
<p>The time searches can be specified via the following dates or datetimes,
down to minutes, e.g.:</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">2017-12-31</span></code></li>
<li><code class="docutils literal"><span class="pre">2017-12-31</span> <span class="pre">23:50</span></code></li>
<li><code class="docutils literal"><span class="pre">2017-12-31T23:50</span></code></li>
<li><code class="docutils literal"><span class="pre">201712312350</span></code></li>
</ul>
<p>Specifying a date will return a date starting at 00:00.</p>
<p>The <code class="docutils literal"><span class="pre">from_date</span></code> and <code class="docutils literal"><span class="pre">to_date</span></code> parameters are optional. The search
API defaults to returning up to the last 30 day&#8217;s worth of tweets.</p>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="n">rule_a</span> <span class="o">=</span> <span class="n">gen_rule_payload</span><span class="p">(</span><span class="n">_rule_a</span><span class="p">,</span>
                        <span class="n">from_date</span><span class="o">=</span><span class="s2">&quot;2017-07-01&quot;</span><span class="p">,</span>
                        <span class="n">to_date</span><span class="o">=</span><span class="s2">&quot;2017-08-01&quot;</span><span class="p">,</span>
                        <span class="n">results_per_call</span><span class="o">=</span><span class="mi">500</span><span class="p">)</span>

<span class="n">rule_a</span>
</pre></div>
</div>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="s1">&#39;{&quot;query&quot;:&quot;(flying OR plane OR landed OR airport OR takeoff)&quot;,&quot;maxResults&quot;:500,&quot;toDate&quot;:&quot;201708010000&quot;,&quot;fromDate&quot;:&quot;201707010000&quot;}&#39;</span>
</pre></div>
</div>
<p>The <code class="docutils literal"><span class="pre">collect_results</span></code> function is the fastest entry point to getting
Tweets. It has several parameters:</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">rule</span></code>: a valid payload made from <code class="docutils literal"><span class="pre">gen_rule_payload</span></code></li>
<li><code class="docutils literal"><span class="pre">max_results</span></code>: the maximum number of Tweets or counts you want to
receive</li>
<li><code class="docutils literal"><span class="pre">result_stream_args</span></code>: the search arguments and authentication info
for this request.</li>
</ul>
<p>And it returns a list of results, Tweets or counts.</p>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="n">results_list</span> <span class="o">=</span> <span class="n">collect_results</span><span class="p">(</span><span class="n">rule_a</span><span class="p">,</span>
                               <span class="n">max_results</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span>
                               <span class="n">result_stream_args</span><span class="o">=</span><span class="n">search_args</span><span class="p">)</span>
</pre></div>
</div>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="c1"># hark, a Tweet!</span>
<span class="n">results_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</pre></div>
</div>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="p">{</span><span class="s1">&#39;contributors&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
 <span class="s1">&#39;coordinates&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
 <span class="s1">&#39;created_at&#39;</span><span class="p">:</span> <span class="s1">&#39;Mon Jul 31 23:59:59 +0000 2017&#39;</span><span class="p">,</span>
 <span class="s1">&#39;entities&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;hashtags&#39;</span><span class="p">:</span> <span class="p">[{</span><span class="s1">&#39;indices&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">43</span><span class="p">,</span> <span class="mi">50</span><span class="p">],</span> <span class="s1">&#39;text&#39;</span><span class="p">:</span> <span class="s1">&#39;defcon&#39;</span><span class="p">}],</span>
  <span class="s1">&#39;symbols&#39;</span><span class="p">:</span> <span class="p">[],</span>
  <span class="s1">&#39;urls&#39;</span><span class="p">:</span> <span class="p">[],</span>
  <span class="s1">&#39;user_mentions&#39;</span><span class="p">:</span> <span class="p">[]},</span>
 <span class="s1">&#39;favorite_count&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
 <span class="s1">&#39;favorited&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
 <span class="s1">&#39;filter_level&#39;</span><span class="p">:</span> <span class="s1">&#39;low&#39;</span><span class="p">,</span>
 <span class="s1">&#39;geo&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
 <span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="mi">892173026116202498</span><span class="p">,</span>
 <span class="s1">&#39;id_str&#39;</span><span class="p">:</span> <span class="s1">&#39;892173026116202498&#39;</span><span class="p">,</span>
 <span class="s1">&#39;in_reply_to_screen_name&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
 <span class="s1">&#39;in_reply_to_status_id&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
 <span class="s1">&#39;in_reply_to_status_id_str&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
 <span class="s1">&#39;in_reply_to_user_id&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
 <span class="s1">&#39;in_reply_to_user_id_str&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
 <span class="s1">&#39;is_quote_status&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
 <span class="s1">&#39;lang&#39;</span><span class="p">:</span> <span class="s1">&#39;en&#39;</span><span class="p">,</span>
 <span class="s1">&#39;matching_rules&#39;</span><span class="p">:</span> <span class="p">[{</span><span class="s1">&#39;tag&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">}],</span>
 <span class="s1">&#39;place&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
 <span class="s1">&#39;quote_count&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
 <span class="s1">&#39;reply_count&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
 <span class="s1">&#39;retweet_count&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
 <span class="s1">&#39;retweeted&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
 <span class="s1">&#39;source&#39;</span><span class="p">:</span> <span class="s1">&#39;&lt;a href=&quot;http://tapbots.com/tweetbot&quot; rel=&quot;nofollow&quot;&gt;Tweetbot for iΟS&lt;/a&gt;&#39;</span><span class="p">,</span>
 <span class="s1">&#39;text&#39;</span><span class="p">:</span> <span class="s1">&#39;Left for airport at 4:45AM, pleased to see #defcon hackers still partying at Caesars bars. Not pleased to be heading to airport at 4:45AM.&#39;</span><span class="p">,</span>
 <span class="s1">&#39;truncated&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
 <span class="s1">&#39;user&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;contributors_enabled&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
  <span class="s1">&#39;created_at&#39;</span><span class="p">:</span> <span class="s1">&#39;Tue Jul 26 12:59:48 +0000 2016&#39;</span><span class="p">,</span>
  <span class="s1">&#39;default_profile&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
  <span class="s1">&#39;default_profile_image&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
  <span class="s1">&#39;derived&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;klout&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;influence_topics&#39;</span><span class="p">:</span> <span class="p">[{</span><span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="s1">&#39;14711&#39;</span><span class="p">,</span>
      <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;Computers&#39;</span><span class="p">,</span>
      <span class="s1">&#39;score&#39;</span><span class="p">:</span> <span class="mf">0.66</span><span class="p">,</span>
      <span class="s1">&#39;url&#39;</span><span class="p">:</span> <span class="s1">&#39;http://klout.com/topic/id/14711&#39;</span><span class="p">},</span>
     <span class="p">{</span><span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="s1">&#39;10000000000000000019&#39;</span><span class="p">,</span>
      <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;Aerospace&#39;</span><span class="p">,</span>
      <span class="s1">&#39;score&#39;</span><span class="p">:</span> <span class="mf">0.51</span><span class="p">,</span>
      <span class="s1">&#39;url&#39;</span><span class="p">:</span> <span class="s1">&#39;http://klout.com/topic/id/10000000000000000019&#39;</span><span class="p">},</span>
     <span class="p">{</span><span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="s1">&#39;5715144008489027056&#39;</span><span class="p">,</span>
      <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;Hacking&#39;</span><span class="p">,</span>
      <span class="s1">&#39;score&#39;</span><span class="p">:</span> <span class="mf">0.51</span><span class="p">,</span>
      <span class="s1">&#39;url&#39;</span><span class="p">:</span> <span class="s1">&#39;http://klout.com/topic/id/5715144008489027056&#39;</span><span class="p">},</span>
     <span class="p">{</span><span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="s1">&#39;6333513374221291742&#39;</span><span class="p">,</span>
      <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;Information Security&#39;</span><span class="p">,</span>
      <span class="s1">&#39;score&#39;</span><span class="p">:</span> <span class="mf">0.48</span><span class="p">,</span>
      <span class="s1">&#39;url&#39;</span><span class="p">:</span> <span class="s1">&#39;http://klout.com/topic/id/6333513374221291742&#39;</span><span class="p">},</span>
     <span class="p">{</span><span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="s1">&#39;10000000000000000013&#39;</span><span class="p">,</span>
      <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;Armed Forces&#39;</span><span class="p">,</span>
      <span class="s1">&#39;score&#39;</span><span class="p">:</span> <span class="mf">0.46</span><span class="p">,</span>
      <span class="s1">&#39;url&#39;</span><span class="p">:</span> <span class="s1">&#39;http://klout.com/topic/id/10000000000000000013&#39;</span><span class="p">}],</span>
    <span class="s1">&#39;interest_topics&#39;</span><span class="p">:</span> <span class="p">[{</span><span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="s1">&#39;6333513374221291742&#39;</span><span class="p">,</span>
      <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;Information Security&#39;</span><span class="p">,</span>
      <span class="s1">&#39;score&#39;</span><span class="p">:</span> <span class="mf">0.7000000000000001</span><span class="p">,</span>
      <span class="s1">&#39;url&#39;</span><span class="p">:</span> <span class="s1">&#39;http://klout.com/topic/id/6333513374221291742&#39;</span><span class="p">},</span>
     <span class="p">{</span><span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="s1">&#39;5715144008489027056&#39;</span><span class="p">,</span>
      <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;Hacking&#39;</span><span class="p">,</span>
      <span class="s1">&#39;score&#39;</span><span class="p">:</span> <span class="mf">0.66</span><span class="p">,</span>
      <span class="s1">&#39;url&#39;</span><span class="p">:</span> <span class="s1">&#39;http://klout.com/topic/id/5715144008489027056&#39;</span><span class="p">},</span>
     <span class="p">{</span><span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="s1">&#39;10000000000000018702&#39;</span><span class="p">,</span>
      <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;Cybersecurity&#39;</span><span class="p">,</span>
      <span class="s1">&#39;score&#39;</span><span class="p">:</span> <span class="mf">0.64</span><span class="p">,</span>
      <span class="s1">&#39;url&#39;</span><span class="p">:</span> <span class="s1">&#39;http://klout.com/topic/id/10000000000000018702&#39;</span><span class="p">},</span>
     <span class="p">{</span><span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="s1">&#39;10000000000000000013&#39;</span><span class="p">,</span>
      <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;Armed Forces&#39;</span><span class="p">,</span>
      <span class="s1">&#39;score&#39;</span><span class="p">:</span> <span class="mf">0.63</span><span class="p">,</span>
      <span class="s1">&#39;url&#39;</span><span class="p">:</span> <span class="s1">&#39;http://klout.com/topic/id/10000000000000000013&#39;</span><span class="p">},</span>
     <span class="p">{</span><span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="s1">&#39;14711&#39;</span><span class="p">,</span>
      <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;Computers&#39;</span><span class="p">,</span>
      <span class="s1">&#39;score&#39;</span><span class="p">:</span> <span class="mf">0.62</span><span class="p">,</span>
      <span class="s1">&#39;url&#39;</span><span class="p">:</span> <span class="s1">&#39;http://klout.com/topic/id/14711&#39;</span><span class="p">}],</span>
    <span class="s1">&#39;profile_url&#39;</span><span class="p">:</span> <span class="s1">&#39;http://klout.com/user/id/120189854649800254&#39;</span><span class="p">,</span>
    <span class="s1">&#39;score&#39;</span><span class="p">:</span> <span class="mi">13</span><span class="p">,</span>
    <span class="s1">&#39;user_id&#39;</span><span class="p">:</span> <span class="s1">&#39;120189854649800254&#39;</span><span class="p">}},</span>
  <span class="s1">&#39;description&#39;</span><span class="p">:</span> <span class="s1">&#39;davrik&#39;</span><span class="p">,</span>
  <span class="s1">&#39;favourites_count&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
  <span class="s1">&#39;follow_request_sent&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
  <span class="s1">&#39;followers_count&#39;</span><span class="p">:</span> <span class="mi">15</span><span class="p">,</span>
  <span class="s1">&#39;following&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
  <span class="s1">&#39;friends_count&#39;</span><span class="p">:</span> <span class="mi">27</span><span class="p">,</span>
  <span class="s1">&#39;geo_enabled&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
  <span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="mi">757923373951422464</span><span class="p">,</span>
  <span class="s1">&#39;id_str&#39;</span><span class="p">:</span> <span class="s1">&#39;757923373951422464&#39;</span><span class="p">,</span>
  <span class="s1">&#39;is_translator&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
  <span class="s1">&#39;lang&#39;</span><span class="p">:</span> <span class="s1">&#39;en&#39;</span><span class="p">,</span>
  <span class="s1">&#39;listed_count&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
  <span class="s1">&#39;location&#39;</span><span class="p">:</span> <span class="s1">&#39;cyber cyber cyber&#39;</span><span class="p">,</span>
  <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;davrik&#39;</span><span class="p">,</span>
  <span class="s1">&#39;notifications&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
  <span class="s1">&#39;profile_background_color&#39;</span><span class="p">:</span> <span class="s1">&#39;F5F8FA&#39;</span><span class="p">,</span>
  <span class="s1">&#39;profile_background_image_url&#39;</span><span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
  <span class="s1">&#39;profile_background_image_url_https&#39;</span><span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
  <span class="s1">&#39;profile_background_tile&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
  <span class="s1">&#39;profile_banner_url&#39;</span><span class="p">:</span> <span class="s1">&#39;https://pbs.twimg.com/profile_banners/757923373951422464/1469539141&#39;</span><span class="p">,</span>
  <span class="s1">&#39;profile_image_url&#39;</span><span class="p">:</span> <span class="s1">&#39;http://pbs.twimg.com/profile_images/757928014541905920/raYPrm1a_normal.jpg&#39;</span><span class="p">,</span>
  <span class="s1">&#39;profile_image_url_https&#39;</span><span class="p">:</span> <span class="s1">&#39;https://pbs.twimg.com/profile_images/757928014541905920/raYPrm1a_normal.jpg&#39;</span><span class="p">,</span>
  <span class="s1">&#39;profile_link_color&#39;</span><span class="p">:</span> <span class="s1">&#39;1DA1F2&#39;</span><span class="p">,</span>
  <span class="s1">&#39;profile_sidebar_border_color&#39;</span><span class="p">:</span> <span class="s1">&#39;C0DEED&#39;</span><span class="p">,</span>
  <span class="s1">&#39;profile_sidebar_fill_color&#39;</span><span class="p">:</span> <span class="s1">&#39;DDEEF6&#39;</span><span class="p">,</span>
  <span class="s1">&#39;profile_text_color&#39;</span><span class="p">:</span> <span class="s1">&#39;333333&#39;</span><span class="p">,</span>
  <span class="s1">&#39;profile_use_background_image&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
  <span class="s1">&#39;protected&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
  <span class="s1">&#39;screen_name&#39;</span><span class="p">:</span> <span class="s1">&#39;0davrik&#39;</span><span class="p">,</span>
  <span class="s1">&#39;statuses_count&#39;</span><span class="p">:</span> <span class="mi">19</span><span class="p">,</span>
  <span class="s1">&#39;time_zone&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
  <span class="s1">&#39;translator_type&#39;</span><span class="p">:</span> <span class="s1">&#39;none&#39;</span><span class="p">,</span>
  <span class="s1">&#39;url&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
  <span class="s1">&#39;utc_offset&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
  <span class="s1">&#39;verified&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">}}</span>
</pre></div>
</div>
</div>
<div class="section" id="parse-twitter-data">
<h2>2. Parse Twitter data<a class="headerlink" href="#parse-twitter-data" title="Permalink to this headline">¶</a></h2>
<p>Let&#8217;s take the 1st Tweet from our results list and discuss its various
elements.</p>
<p>Tweet data is returned from the API as a single JSON payload with a
<code class="docutils literal"><span class="pre">results</span></code> array, containing many JSON Tweet payloads. The
<code class="docutils literal"><span class="pre">searchtweets</span></code> package parses that data for you (including abstracting
away concerns about the specific format of the Tweet payloads) using our
<code class="docutils literal"><span class="pre">`tweet_parser</span></code> &lt;<a class="reference external" href="https://github.com/tw-ddis/tweet_parser">https://github.com/tw-ddis/tweet_parser</a>&gt;`__ package
and handles any errors caused by non-Tweet messages (like logging
messages), returning <code class="docutils literal"><span class="pre">Tweet</span></code> objects (I&#8217;ll explain about that in a
second).</p>
<p>To better understand Tweets, you should check out <a class="reference external" href="https://developer.twitter.com/en/docs/tweets/data-dictionary/overview/intro-to-tweet-json">our developer
website</a>
for information on Tweet payload elements. For now, I&#8217;m going to explain
a few key elements of a Tweet and how to access them.</p>
</div>
<div class="section" id="the-nitty-gritty-tweet-payloads">
<h2>The nitty gritty: Tweet payloads<a class="headerlink" href="#the-nitty-gritty-tweet-payloads" title="Permalink to this headline">¶</a></h2>
<p>We&#8217;ll grab a single example Tweet: just the first one from our list.
This is a Tweet object, which has all of the properties of a Python
<code class="docutils literal"><span class="pre">dict</span></code> as well as some special, Tweet-specific attributes.</p>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="n">example_tweet</span> <span class="o">=</span> <span class="n">results_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">example_tweet</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]</span>
</pre></div>
</div>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="mi">892173026116202498</span>
</pre></div>
</div>
<p><strong>A note on Tweet formatting and payload element naming</strong></p>
<p>It just so happens that the format of this Tweet is &#8220;original format,&#8221;
so we can look up the keys (names of payload elements) on our support
website. It&#8217;s possible (but unlikely) that your Search API stream is
configured slightly differently, and you&#8217;re looking at &#8220;activity
streams&#8221; formatted Tweets (if so, this is completely fine). We&#8217;ll add
the equivalent &#8220;activity streams&#8221; keys in the comments.</p>
<p>You can look up specific of Tweet payload elements
<a class="reference external" href="https://developer.twitter.com/en/docs/tweets/data-dictionary/overview/tweet-object">here</a>.</p>
<p>Note that the <code class="docutils literal"><span class="pre">tweet_parser</span></code> package will abstract away the format of
the Tweet, and either activity streams or original format will work fine
in this notebook.</p>
<p><strong>Now, the text of a Tweet:</strong></p>
<p>The text of the Tweet (the thing you type, the characters that display
in the Tweet) is stored as a top-level key called &#8220;text.&#8221;</p>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">results_list</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;text&quot;</span><span class="p">])</span>

<span class="c1"># uncomment the following if you appear to have an activity-stream formatted Tweet</span>
<span class="c1"># (the names of the payload elements are different, the data is the same):</span>
<span class="c1"># results_list[0][&quot;body&quot;]</span>
</pre></div>
</div>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">Left</span> <span class="k">for</span> <span class="n">airport</span> <span class="n">at</span> <span class="mi">4</span><span class="p">:</span><span class="mi">45</span><span class="n">AM</span><span class="p">,</span> <span class="n">pleased</span> <span class="n">to</span> <span class="n">see</span> <span class="c1">#defcon hackers still partying at Caesars bars. Not pleased to be heading to airport at 4:45AM.</span>
</pre></div>
</div>
<div class="line-block">
<div class="line"><strong>Other Tweet elements</strong></div>
<div class="line">Be sure to read the documentation, we cannot enumerate every Tweet
element here. Note that certain fundamental and useful Tweet elements
are extracted for you, such as a #hashtag or an &#64;mention.</div>
</div>
<p>You can access, for instance, a Tweet&#8217;s #hashtags like this:</p>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="n">results_list</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;entities&quot;</span><span class="p">][</span><span class="s2">&quot;hashtags&quot;</span><span class="p">]</span>

<span class="c1"># uncomment the following if you appear to have an activity-stream formatted Tweet</span>
<span class="c1"># results_list[0][&quot;twitter_entities&quot;][&quot;hashtags&quot;]</span>
</pre></div>
</div>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="p">[{</span><span class="s1">&#39;indices&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">43</span><span class="p">,</span> <span class="mi">50</span><span class="p">],</span> <span class="s1">&#39;text&#39;</span><span class="p">:</span> <span class="s1">&#39;defcon&#39;</span><span class="p">}]</span>
</pre></div>
</div>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="c1"># in case that first Tweet didn&#39;t actually have any hashtags:</span>
<span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="s2">&quot;entities&quot;</span><span class="p">][</span><span class="s2">&quot;hashtags&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">results_list</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">10</span><span class="p">]]</span>

<span class="c1"># uncomment the following if you appear to have an activity-stream formatted Tweet</span>
<span class="c1"># [x[&quot;twitter_entities&quot;][&quot;hashtags&quot;] for x in results_list[0:10]]</span>
</pre></div>
</div>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="p">[[{</span><span class="s1">&#39;indices&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">43</span><span class="p">,</span> <span class="mi">50</span><span class="p">],</span> <span class="s1">&#39;text&#39;</span><span class="p">:</span> <span class="s1">&#39;defcon&#39;</span><span class="p">}],</span>
 <span class="p">[],</span>
 <span class="p">[{</span><span class="s1">&#39;indices&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">22</span><span class="p">,</span> <span class="mi">30</span><span class="p">],</span> <span class="s1">&#39;text&#39;</span><span class="p">:</span> <span class="s1">&#39;Algerie&#39;</span><span class="p">}],</span>
 <span class="p">[],</span>
 <span class="p">[],</span>
 <span class="p">[{</span><span class="s1">&#39;indices&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">],</span> <span class="s1">&#39;text&#39;</span><span class="p">:</span> <span class="s1">&#39;New&#39;</span><span class="p">}],</span>
 <span class="p">[],</span>
 <span class="p">[],</span>
 <span class="p">[],</span>
 <span class="p">[]]</span>
</pre></div>
</div>
</div>
<div class="section" id="tweet-parser">
<h2>tweet_parser<a class="headerlink" href="#tweet-parser" title="Permalink to this headline">¶</a></h2>
<p>You will always need to understand Tweet payloads to work with Tweets,
but a Python package from this team (<code class="docutils literal"><span class="pre">pip</span> <span class="pre">install</span> <span class="pre">tweet_parser</span></code>)
attempts to remove some of the hassle of accessing elements of a Tweet.
This package works seamlessly with both possible Twitter data formats,
and supplies the <code class="docutils literal"><span class="pre">Tweet</span></code> object we referred to earlier.</p>
<p>Before doing a lot of work with this package (but not right this
minute!), we would encourage you to read the documentation for the
<code class="docutils literal"><span class="pre">tweet_parser</span></code> package at <a class="reference external" href="https://twitterdev.github.io/tweet_parser/">https://twitterdev.github.io/tweet_parser/</a>.
The package is open-source and available on GitHub at
<a class="reference external" href="https://github.com/twitterdev/tweet_parser">https://github.com/twitterdev/tweet_parser</a>. Feel free to submit issues
or make pull requests.</p>
<p>The <code class="docutils literal"><span class="pre">Tweet</span></code> object has properties that allow you to access useful
elements of a Tweet without dealing with its format. For instance, we
can access some of the text fields of a Tweet with:</p>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Literally the content of the &#39;text&#39; field: </span><span class="se">\n</span><span class="si">{}</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">results_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">text</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Other fields, like the content of a quoted tweet or the options of a poll: </span><span class="si">{}</span><span class="s2">, </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
    <span class="n">results_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">quoted_tweet</span><span class="o">.</span><span class="n">text</span> <span class="k">if</span> <span class="n">results_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">quoted_tweet</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">results_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">poll_options</span><span class="p">))</span>
</pre></div>
</div>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">Literally</span> <span class="n">the</span> <span class="n">content</span> <span class="n">of</span> <span class="n">the</span> <span class="s1">&#39;text&#39;</span> <span class="n">field</span><span class="p">:</span>
<span class="n">Left</span> <span class="k">for</span> <span class="n">airport</span> <span class="n">at</span> <span class="mi">4</span><span class="p">:</span><span class="mi">45</span><span class="n">AM</span><span class="p">,</span> <span class="n">pleased</span> <span class="n">to</span> <span class="n">see</span> <span class="c1">#defcon hackers still partying at Caesars bars. Not pleased to be heading to airport at 4:45AM.</span>

<span class="n">Other</span> <span class="n">fields</span><span class="p">,</span> <span class="n">like</span> <span class="n">the</span> <span class="n">content</span> <span class="n">of</span> <span class="n">a</span> <span class="n">quoted</span> <span class="n">tweet</span> <span class="ow">or</span> <span class="n">the</span> <span class="n">options</span> <span class="n">of</span> <span class="n">a</span> <span class="n">poll</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="p">[]</span>
</pre></div>
</div>
<p>As the Twitter platform changes, so do the fields in the data payload.
For instance, &#8220;extended&#8221; and &#8220;truncated&#8221; tweets have been introduced to
stop 280 character from causing breaking changes. The <code class="docutils literal"><span class="pre">Tweet</span></code> object
has a convenience property <code class="docutils literal"><span class="pre">.all_text</span></code> that gets &#8220;all&#8221; the text that a
Tweet displays.</p>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="n">results_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">all_text</span>
</pre></div>
</div>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="s1">&#39;Left for airport at 4:45AM, pleased to see #defcon hackers still partying at Caesars bars. Not pleased to be heading to airport at 4:45AM.&#39;</span>
</pre></div>
</div>
<p>We cannot dive into detail on every property of <code class="docutils literal"><span class="pre">Tweet</span></code> that we&#8217;ll use
in this notebook, but hopefully you get the idea. When we call
<code class="docutils literal"><span class="pre">.something</span></code> on a <code class="docutils literal"><span class="pre">Tweet</span></code>, that <code class="docutils literal"><span class="pre">.something</span></code> is provided in the
<code class="docutils literal"><span class="pre">tweet_parser</span></code> package and documented there.</p>
<p>For now, we will describe the elements of the payload that we&#8217;ll use in
this analysis.</p>
<ul class="simple">
<li><strong>time</strong>: The time that a Tweet was created. This is always reported
in UTC in the Tweet payload, and you can look for the user&#8217;s timezone
in the &#8220;user&#8221; portion of a Tweet payload if you want to translate
this time to the user&#8217;s time-of-day. A string of time information can
be found in the <code class="docutils literal"><span class="pre">created_at</span></code> element of a Tweet, but since we&#8217;re
using the <code class="docutils literal"><span class="pre">tweet_parser</span></code> package, we can access a Python datetime
object with <code class="docutils literal"><span class="pre">tweet.created_at_datetime</span></code> or an integer representing
seconds since Jan 1, 1970 with <code class="docutils literal"><span class="pre">tweet.created_at_seconds</span></code>.</li>
<li><strong>user</strong>: The user who created the Tweet. The &#8220;user&#8221; portion of a
Tweet payload contains many valuable elements, including the user&#8217;s
id (<code class="docutils literal"><span class="pre">tweet[&quot;user&quot;][&quot;id&quot;]</span></code>, or <code class="docutils literal"><span class="pre">tweet.user_id</span></code> with the
<code class="docutils literal"><span class="pre">tweet_parser</span></code> package), the user&#8217;s screen name
(<code class="docutils literal"><span class="pre">tweet.screen_name</span></code>, keep in mind that the user name may change),
the user&#8217;s timezone, potentially their derived location, their bio (a
user-entered description at, <code class="docutils literal"><span class="pre">tweet.bio</span></code>) and more.</li>
<li><strong>text</strong>: The text of the Tweet. As Tweets get more complex
(Retweets, Quote Tweets, poll Tweets, Tweets with hidden &#64;-mentions
and links), the text that you read in a Tweet can appear in many
different areas of a Tweet payload. Here using the
<code class="docutils literal"><span class="pre">tweet_parser</span></code>-provided attribute <code class="docutils literal"><span class="pre">tweet.all_text</span></code>, which
aggregates all of the possible text fields of a Tweet (the quoted
text, the poll text, the hidden &#64;-mentions, etc) into one string.</li>
<li><strong>hashtags</strong>: Tweet payloads contain a field that list hashtags
present in the Tweet (you do not have to parse them out yourself).
The <code class="docutils literal"><span class="pre">tweet_parser</span></code> Tweet attribute <code class="docutils literal"><span class="pre">tweet.hashtags</span></code> provides a
list of hashtags.</li>
<li><strong>mentions</strong>: You don&#8217;t have to parse out &#64;-mentions yourself either.
Use <code class="docutils literal"><span class="pre">tweet.user_mentions</span></code> for a list of users (names and ids)
mentioned in a Tweet.</li>
<li><strong>URLs</strong>: Many Tweet contain links to outside sources, articles or
media. You can pull the literal link text from a Tweet, or use
Twitter&#8217;s URL enrichments (if you&#8217;ve purchased them) to unroll URLs
and get insight into the linked content.</li>
<li><strong>geo</strong>: For the small sample of Tweets where explicit lat/lon geo
data is available, use <code class="docutils literal"><span class="pre">tweet.geo_coordinates</span></code> to get locations.</li>
</ul>
<p>Now we can take all of those aforementioned elements, parse them out of
my Tweets, and put them in a
<a class="reference external" href="https://pandas.pydata.org/pandas-docs/stable/">Pandas</a>
<a class="reference external" href="https://pandas.pydata.org/pandas-docs/stable/dsintro.html#dataframe">Dataframe</a>.</p>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>

<span class="c1"># make a pandas dataframe</span>
<span class="n">data_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">([{</span><span class="s2">&quot;date&quot;</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">created_at_datetime</span><span class="p">,</span>
                         <span class="s2">&quot;text&quot;</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">all_text</span><span class="p">,</span>
                         <span class="s2">&quot;user&quot;</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">screen_name</span><span class="p">,</span>
                         <span class="s2">&quot;bio&quot;</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">bio</span><span class="p">,</span>
                         <span class="s2">&quot;at_mentions&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">u</span><span class="p">[</span><span class="s2">&quot;screen_name&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">u</span> <span class="ow">in</span> <span class="n">x</span><span class="o">.</span><span class="n">user_mentions</span><span class="p">],</span>
                         <span class="s2">&quot;hashtags&quot;</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">hashtags</span><span class="p">,</span>
                         <span class="s2">&quot;urls&quot;</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">most_unrolled_urls</span><span class="p">,</span>
                         <span class="s2">&quot;geo&quot;</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">geo_coordinates</span><span class="p">,</span>
                         <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">tweet_type</span><span class="p">,</span>
                         <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">id</span><span class="p">}</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">results_list</span><span class="p">])</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s2">&quot;date&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="before-you-read-these-tweets">
<h2>Before you read these Tweets<a class="headerlink" href="#before-you-read-these-tweets" title="Permalink to this headline">¶</a></h2>
<p>You&#8217;re going to look at this Tweet data and you (should) feel a little
sad. We did all that work talking about rules, you&#8217;ve heard so much
about Twitter data, and these Tweets mostly don&#8217;t seem relevant to our
usecase at all. They&#8217;re not from our target audience (people flying on
planes) and they&#8217;re not even necessarily about plane trips. What gives?</p>
<p>There&#8217;s a reason we started out with only one API call: we didn&#8217;t want
to waste calls pulling Tweets using an unrefined ruleset. This notebook
is going to be about making better decisions about rules, iterating, and
refining them until you get the Tweets that you want. And those Tweets
are out there - there are, after all, <em>lots</em> of Tweets.</p>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="c1"># data, parsed out and ready to analyze</span>
<span class="n">data_df</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>at_mentions</th>
      <th>bio</th>
      <th>geo</th>
      <th>hashtags</th>
      <th>id</th>
      <th>text</th>
      <th>type</th>
      <th>urls</th>
      <th>user</th>
    </tr>
    <tr>
      <th>date</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>2017-07-31 23:59:59</th>
      <td>[]</td>
      <td>davrik</td>
      <td>None</td>
      <td>[defcon]</td>
      <td>892173026116202498</td>
      <td>Left for airport at 4:45AM, pleased to see #de...</td>
      <td>tweet</td>
      <td>[]</td>
      <td>0davrik</td>
    </tr>
    <tr>
      <th>2017-07-31 23:59:58</th>
      <td>[God1stAmerica2d]</td>
      <td>Proudly Politically Incorrect. Widow of US Mar...</td>
      <td>None</td>
      <td>[]</td>
      <td>892173019040202752</td>
      <td>Why is this even a question. ID needed for lic...</td>
      <td>retweet</td>
      <td>[https://twitter.com/i/web/status/892144209418...</td>
      <td>AliasHere</td>
    </tr>
    <tr>
      <th>2017-07-31 23:59:57</th>
      <td>[LPLdirect]</td>
      <td>🇬🇳🇺🇸</td>
      <td>None</td>
      <td>[Algerie]</td>
      <td>892173017186435073</td>
      <td>🔴INFOS #Algerie\n\nDeux pilotes d' Air Algérie...</td>
      <td>retweet</td>
      <td>[https://twitter.com/i/web/status/892152194920...</td>
      <td>Wyzzyddl</td>
    </tr>
    <tr>
      <th>2017-07-31 23:59:57</th>
      <td>[Simbaki_]</td>
      <td>🏳️‍🌈 sc : kailabrielleeee / match ?</td>
      <td>None</td>
      <td>[]</td>
      <td>892173016372838400</td>
      <td>We are unappreciative... we don't deserve Take...</td>
      <td>retweet</td>
      <td>[]</td>
      <td>KailaBrielleee_</td>
    </tr>
    <tr>
      <th>2017-07-31 23:59:56</th>
      <td>[realDonaldTrump]</td>
      <td>Consultant • 💻 Network Engineer • brunch advoc...</td>
      <td>None</td>
      <td>[]</td>
      <td>892173013625573376</td>
      <td>@realDonaldTrump Watch Trump get lost going fr...</td>
      <td>quote</td>
      <td>[https://twitter.com/i/web/status/892173013625...</td>
      <td>LoveRunandPray</td>
    </tr>
  </tbody>
</table>
</div></div>
<div class="section" id="describe-your-data">
<h2>3. Describe your data<a class="headerlink" href="#describe-your-data" title="Permalink to this headline">¶</a></h2>
<p>Descriptive statistics can tell you a lot about your dataset with very
little special effort and customization. Having a good set of
descriptive statistics coded up that you always run on a new dataset can
be helpful. Our team maintains
<a class="reference external" href="https://github.com/tw-ddis/Gnip-Tweet-Evaluation">Gnip-Tweet-Evaluation</a>
a repository on GitHub that contains some tools to do quick evaluation
of a Tweet corpus (that package is useful as a command line tool, and as
a template for Tweet evaluation).</p>
<p>I&#8217;m going to walk through a few different statistics that might help us
understand the data better: - <strong>What is generating the Tweets?</strong>: One
statistic that is common and useful in understanding a group of Tweets
is understanding how many of them are Retweets or Quote Tweets. Another
interesting data point can be looking at the application that created
the Tweet itself. - <strong>Common words</strong>: What are the most common words in
the corpus? Are they what we expected? Are they relevant to the topic of
interest? - <strong>Who is Tweeting</strong>: Who are the users who Tweet the most?
Are there spammy users that should be removed? Are they important users
that we need to pay attention to? - <strong>Where are they Tweeting from</strong>:
What&#8217;s the distribution of Tweet locations? Is that surprising? - <strong>Time
series</strong>: Are there spikes in the Tweet volume? When do they occur? What
drives the spikes? For the sake of filtering out noise (or news stories
that we don&#8217;t care about) it may be important to identify spikes and
filter out the Tweets that drive those spikes.</p>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="c1"># plotting library</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="c1"># pretty plots</span>
<span class="n">plt</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">use</span><span class="p">(</span><span class="s2">&quot;bmh&quot;</span><span class="p">)</span>
<span class="c1"># better sizing for the notebook</span>
<span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;figure.figsize&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
<span class="o">%</span><span class="n">matplotlib</span> <span class="n">inline</span>
</pre></div>
</div>
</div>
<div class="section" id="how-are-people-tweeting">
<h2>How are people Tweeting?<a class="headerlink" href="#how-are-people-tweeting" title="Permalink to this headline">¶</a></h2>
<p>Briefly, let&#8217;s note that there are several different Twitter platform
actions that can create a Tweet. - <strong>original Tweet</strong>: the user created
a Tweet by typing it into the Tweet create box or otherwise hitting the
<code class="docutils literal"><span class="pre">statuses/update</span></code> endpoint - <strong>Retweet</strong>: the user reposted the Tweet
to their own timeline, without adding and comment - <strong>Quote Tweet</strong>:
user added commentary to a reposted Tweet, essentially a Tweet with
another Tweet embedded in it</p>
<p>This is sometimes an important distinction: how much do Retweets or
Quote Tweets represent the experience of the user reposting? Do we
actually want Retweets in our particular dataset? Are they likely to
tell us anything about users who are actually traveling (put it this
way: if a user Retweets a story about being at an airport, how likely
does it seem that they are at an airport)?</p>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="n">data_df</span><span class="p">[[</span><span class="s2">&quot;type&quot;</span><span class="p">,</span><span class="s2">&quot;id&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;type&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>
</pre></div>
</div>
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>id</th>
    </tr>
    <tr>
      <th>type</th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>quote</th>
      <td>16</td>
    </tr>
    <tr>
      <th>retweet</th>
      <td>298</td>
    </tr>
    <tr>
      <th>tweet</th>
      <td>186</td>
    </tr>
  </tbody>
</table>
</div></div>
<div class="section" id="common-words">
<h2>Common words<a class="headerlink" href="#common-words" title="Permalink to this headline">¶</a></h2>
<p>Definitions: - <strong>corpus</strong>: A collection of all of the documents that we
are analyzing. - <strong>document</strong>: A single piece of writing, in our case, a
single Tweet - <strong>token</strong>: Some characters from a document. Ideally,
tokens would be common enough to occur in many documents, and have some
semantic meaning&#8211;they provide us with a way to infer semantic
correlation across documents. - <strong>stop word</strong>: A stop word (something
like &#8220;and&#8221;,&#8221;but&#8221;,&#8221;the&#8221;) is a very common word with little semantic
meaning, and we often exclude these words from word counts or NLP
models.</p>
<div class="line-block">
<div class="line"><strong>Tokenization</strong></div>
<div class="line">In order to count common terms, first we have to define our terms. The
easiest thing for me to count is a token&#8211;a single unit of characters
in a Tweet. Often we try to define tokens so that a token is basically
a word.</div>
</div>
<p>I&#8217;m going to tokenize the Tweets (split each Tweet into a list of
tokens) using the <a class="reference external" href="http://www.nltk.org/api/nltk.tokenize.html#module-nltk.tokenize.casual">nltk
TweetTokenizer</a>,
which splits on spaces and throws away some punctuation. We will also
throw away any tokens that contain no letters, and throw away any tokens
that are less than 3 characters long. These choices&#8211;how to define a
token, and which tokens to count, are somewhat arbitrary, but depend
greatly on how language is used in the dataset. For instance, many
tokenizers would remove the symbols &#8220;&#64;&#8221; and &#8220;#&#8221; as punctuation, but on
Twitter, those symbols mean something (&#8220;&#64;Jack&#8221; is potentially very
different from &#8220;jack&#8221;), and should perhaps be preserved.</p>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">nltk.tokenize</span> <span class="k">import</span> <span class="n">TweetTokenizer</span>
<span class="kn">from</span> <span class="nn">nltk.stem.porter</span> <span class="k">import</span> <span class="n">PorterStemmer</span>

<span class="k">def</span> <span class="nf">tweet_tokenizer</span><span class="p">(</span><span class="n">verbatim</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">tokenizer</span> <span class="o">=</span> <span class="n">TweetTokenizer</span><span class="p">()</span>
        <span class="n">all_tokens</span> <span class="o">=</span> <span class="n">tokenizer</span><span class="o">.</span><span class="n">tokenize</span><span class="p">(</span><span class="n">verbatim</span><span class="o">.</span><span class="n">lower</span><span class="p">())</span>
        <span class="c1"># this line filters out all tokens that are entirely non-alphabetic characters</span>
        <span class="n">filtered_tokens</span> <span class="o">=</span> <span class="p">[</span><span class="n">t</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">all_tokens</span> <span class="k">if</span> <span class="n">t</span><span class="o">.</span><span class="n">islower</span><span class="p">()]</span>
        <span class="c1"># filter out all tokens that are &lt;=2 chars</span>
        <span class="n">filtered_tokens</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">filtered_tokens</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">2</span><span class="p">]</span>
    <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
        <span class="n">filtered_tokens</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">return</span><span class="p">(</span><span class="n">filtered_tokens</span><span class="p">)</span>
</pre></div>
</div>
<p><strong>Counting</strong></p>
<p>Of course, we could simply create a dictionary of tokens in our corpus
and iterate through the entire corpus of Tweets and adding &#8220;1&#8221; to a
count every time we encounter a certain token, but it&#8217;s more convenient
to start using the scikit-learn API now and put our token counts into a
format that&#8217;s easy to use later. If you&#8217;re unfamiliar with scikit-learn,
it is an excellent Python machine learning framework that implements
many common ML algorithms in a common building-block-able API.</p>
<p>I am going to use <a class="reference external" href="http://scikit-learn.org/stable/modules/generated/sklearn.feature_extraction.text.CountVectorizer.html">scikit-learn&#8217;s
CountVectorizer</a>
to count tokens and turn the corpus into a document-term matrix. This
makes it easy to count token frequencies. Note that the CountVectorizer
allows us to count not only terms (&#8220;tokens&#8221;) but n-grams (collections of
tokens). For instance, if &#8220;plane&#8221; and &#8220;trip&#8221; are both tokens split on
spaces, then explicit phrase &#8220;plane trip&#8221; might be a 2-gram in our
corpus.</p>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="c1"># get the most common words in Tweets</span>
<span class="kn">from</span> <span class="nn">sklearn.feature_extraction.text</span> <span class="k">import</span> <span class="n">CountVectorizer</span>

<span class="k">def</span> <span class="nf">get_frequent_terms</span><span class="p">(</span><span class="n">text_series</span><span class="p">,</span> <span class="n">stop_words</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">ngram_range</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">)):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Input:</span>
<span class="sd">       text_series: a list or series of documents</span>
<span class="sd">       stop_words: a list of stop_words to ignore, or the string &#39;english&#39;,</span>
<span class="sd">                   which uses a built-in stop word list for the english language.</span>
<span class="sd">                   By default, there are no stop words used</span>
<span class="sd">       ngram_range: a single int, or a 2 tuple representing the range of ngrams to count.</span>
<span class="sd">                    the default (1,2) counts 1- and 2- grams.</span>
<span class="sd">    Returns:</span>
<span class="sd">       a dataframe of counts, indexed by n-gram</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">count_vectorizer</span> <span class="o">=</span> <span class="n">CountVectorizer</span><span class="p">(</span><span class="n">analyzer</span> <span class="o">=</span> <span class="s2">&quot;word&quot;</span><span class="p">,</span>
                                       <span class="n">tokenizer</span> <span class="o">=</span> <span class="n">tweet_tokenizer</span><span class="p">,</span>
                                       <span class="n">stop_words</span> <span class="o">=</span> <span class="n">stop_words</span><span class="p">,</span> <span class="c1"># try changing the stopword sets that we use.</span>
                                                                <span class="c1"># notice that many top terms are words like</span>
                                                                <span class="c1"># &quot;and&quot; and &quot;the&quot;</span>
                                       <span class="n">ngram_range</span> <span class="o">=</span> <span class="n">ngram_range</span> <span class="c1"># you can change this to count frequencies of</span>
                                                           <span class="c1"># ngrams as well as single tokens</span>
                                                           <span class="c1"># a range of (1,2) counts 1-grams (single tokens) and</span>
                                                           <span class="c1"># 2-grams (2-token phrases)</span>
                                      <span class="p">)</span>
    <span class="n">term_freq_matrix</span> <span class="o">=</span> <span class="n">count_vectorizer</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">text_series</span><span class="p">)</span>
    <span class="n">terms</span> <span class="o">=</span> <span class="n">count_vectorizer</span><span class="o">.</span><span class="n">get_feature_names</span><span class="p">()</span>
    <span class="n">term_frequencies</span> <span class="o">=</span> <span class="n">term_freq_matrix</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">tolist</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>

    <span class="n">term_freq_df</span> <span class="o">=</span> <span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">terms</span><span class="p">,</span> <span class="n">term_frequencies</span><span class="p">)),</span> <span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;token&quot;</span><span class="p">,</span><span class="s2">&quot;count&quot;</span><span class="p">])</span>
                    <span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s2">&quot;token&quot;</span><span class="p">)</span>
                    <span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s2">&quot;count&quot;</span><span class="p">,</span><span class="n">ascending</span> <span class="o">=</span> <span class="kc">False</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">term_freq_df</span>
</pre></div>
</div>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="n">term_freq_df</span> <span class="o">=</span> <span class="n">get_frequent_terms</span><span class="p">(</span><span class="n">data_df</span><span class="p">[</span><span class="s2">&quot;text&quot;</span><span class="p">],</span>
                                  <span class="n">stop_words</span> <span class="o">=</span> <span class="s2">&quot;english&quot;</span><span class="p">)</span> <span class="c1"># stop_words = &quot;english&quot; removes words like &#39;and&#39;</span>
</pre></div>
</div>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="n">term_freq_df</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span>
</pre></div>
</div>
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>count</th>
    </tr>
    <tr>
      <th>token</th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>airport</th>
      <td>196</td>
    </tr>
    <tr>
      <th>flying</th>
      <td>123</td>
    </tr>
    <tr>
      <th>plane</th>
      <td>94</td>
    </tr>
    <tr>
      <th>landed</th>
      <td>48</td>
    </tr>
    <tr>
      <th>home</th>
      <td>31</td>
    </tr>
    <tr>
      <th>trump</th>
      <td>30</td>
    </tr>
    <tr>
      <th>today</th>
      <td>29</td>
    </tr>
    <tr>
      <th>harry</th>
      <td>27</td>
    </tr>
    <tr>
      <th>just</th>
      <td>27</td>
    </tr>
    <tr>
      <th>flight</th>
      <td>26</td>
    </tr>
    <tr>
      <th>flying home</th>
      <td>25</td>
    </tr>
    <tr>
      <th>got</th>
      <td>24</td>
    </tr>
    <tr>
      <th>meeting</th>
      <td>24</td>
    </tr>
    <tr>
      <th>initial</th>
      <td>23</td>
    </tr>
    <tr>
      <th>dictated</th>
      <td>23</td>
    </tr>
    <tr>
      <th>statement</th>
      <td>23</td>
    </tr>
    <tr>
      <th>personally</th>
      <td>22</td>
    </tr>
    <tr>
      <th>personally dictated</th>
      <td>22</td>
    </tr>
    <tr>
      <th>trump personally</th>
      <td>22</td>
    </tr>
    <tr>
      <th>g20</th>
      <td>22</td>
    </tr>
  </tbody>
</table>
</div><div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="n">term_freq_df</span><span class="o">.</span><span class="n">tail</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
</pre></div>
</div>
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>count</th>
    </tr>
    <tr>
      <th>token</th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>flying broom</th>
      <td>1</td>
    </tr>
    <tr>
      <th>flying bullets</th>
      <td>1</td>
    </tr>
    <tr>
      <th>flying california</th>
      <td>1</td>
    </tr>
    <tr>
      <th>flying car</th>
      <td>1</td>
    </tr>
    <tr>
      <th>flying cases</th>
      <td>1</td>
    </tr>
    <tr>
      <th>flying centre</th>
      <td>1</td>
    </tr>
    <tr>
      <th>flying chalice</th>
      <td>1</td>
    </tr>
    <tr>
      <th>flying check</th>
      <td>1</td>
    </tr>
    <tr>
      <th>flying close</th>
      <td>1</td>
    </tr>
    <tr>
      <th>蕾阿蕾丶elahe https://t.co/y74vcswiuq</th>
      <td>1</td>
    </tr>
  </tbody>
</table>
</div><p><strong>Hand labeling</strong></p>
<p>Never underestimate the value of reading through your data. Actually
look at the terms in the Tweets. Identify the Tweets that look like ones
you are actually interested in.</p>
<p>Consider doing something like searching for specific, relevant, phrases
that you hope will show up in your data:</p>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="n">data_df</span><span class="p">[</span><span class="n">data_df</span><span class="p">[</span><span class="s1">&#39;text&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="s1">&#39;flying home&#39;</span><span class="p">)]</span>
</pre></div>
</div>
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>at_mentions</th>
      <th>bio</th>
      <th>geo</th>
      <th>hashtags</th>
      <th>id</th>
      <th>text</th>
      <th>type</th>
      <th>urls</th>
      <th>user</th>
    </tr>
    <tr>
      <th>date</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>2017-07-31 23:58:33</th>
      <td>[WilkinsHarley]</td>
      <td>None</td>
      <td>None</td>
      <td>[]</td>
      <td>892172664948871168</td>
      <td>@WilkinsHarley We would love too! Unfortunatel...</td>
      <td>tweet</td>
      <td>[]</td>
      <td>ChrisLeFrenchy</td>
    </tr>
  </tbody>
</table>
</div><p>Or simply reading a few random Tweets in your data.</p>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="n">pd</span><span class="o">.</span><span class="n">set_option</span><span class="p">(</span><span class="s1">&#39;display.max_colwidth&#39;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
<span class="n">data_df</span><span class="p">[[</span><span class="s1">&#39;text&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
</pre></div>
</div>
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>text</th>
    </tr>
    <tr>
      <th>date</th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>2017-07-31 23:59:29</th>
      <td>@IFLYGLACIER I never complain about things like this, but Kalispell Airport security's reckless negligence was unacceptable and harmful behavior today.</td>
    </tr>
    <tr>
      <th>2017-07-31 23:58:08</th>
      <td>Gostei de um vídeo @YouTube https://t.co/4VXfrqw4yg Plane</td>
    </tr>
    <tr>
      <th>2017-07-31 23:57:31</th>
      <td>a whole 9 second of jeongyeon taking care of tzuyu's skirt from flying 😭💛 https://t.co/lSDVZYWfrR</td>
    </tr>
    <tr>
      <th>2017-07-31 23:59:34</th>
      <td>🔴INFOS #Algerie\n\nDeux pilotes d' Air Algérie sont suspendu pour avoir laisser un enfant manipuler un avion en vol https://t.co/wh8Fmk71MX https://t.co/KHSz2nkvSs</td>
    </tr>
    <tr>
      <th>2017-07-31 23:57:04</th>
      <td>RT: This is why I'm jumping out of a plane on 18/08 to raise funds to help @LIONAID #SaveLions. Please sponsor me at https://t.co/6GY8WSmEkz https://t.co/U27B8YEofX</td>
    </tr>
  </tbody>
</table>
</div><p>A subsequent post will cover unsupervised clustering, which can help you
group together Tweets to more easily make sense of them (you might group
Tweets into 10 groups, and read a few Tweets from each group).</p>
</div>
<div class="section" id="who-is-tweeting-who-is-speaking">
<h2>Who is Tweeting? Who is speaking?<a class="headerlink" href="#who-is-tweeting-who-is-speaking" title="Permalink to this headline">¶</a></h2>
<p>I&#8217;m going to use some Pandas tricks (<code class="docutils literal"><span class="pre">.groupby</span></code> and <code class="docutils literal"><span class="pre">.agg</span></code>) to find
the most commonly Tweeting users in the dataset.</p>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="p">(</span><span class="n">data_df</span><span class="p">[[</span><span class="s2">&quot;user&quot;</span><span class="p">,</span><span class="s2">&quot;bio&quot;</span><span class="p">,</span><span class="s2">&quot;geo&quot;</span><span class="p">,</span><span class="s2">&quot;id&quot;</span><span class="p">]]</span>
    <span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;user&quot;</span><span class="p">)</span>
    <span class="o">.</span><span class="n">agg</span><span class="p">({</span><span class="s2">&quot;id&quot;</span><span class="p">:</span><span class="s2">&quot;count&quot;</span><span class="p">,</span><span class="s2">&quot;bio&quot;</span><span class="p">:</span><span class="s2">&quot;first&quot;</span><span class="p">,</span><span class="s2">&quot;geo&quot;</span><span class="p">:</span><span class="s2">&quot;first&quot;</span><span class="p">})</span>
    <span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s2">&quot;id&quot;</span><span class="p">,</span><span class="n">ascending</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span>
    <span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;id&#39;</span><span class="p">:</span><span class="s1">&#39;tweet_count&#39;</span><span class="p">})</span>
<span class="p">)</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">15</span><span class="p">)</span>
</pre></div>
</div>
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>tweet_count</th>
      <th>bio</th>
      <th>geo</th>
    </tr>
    <tr>
      <th>user</th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>babyieturtle</th>
      <td>6</td>
      <td>ELF | YG/Rapper🌸</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>P3air</th>
      <td>3</td>
      <td>Worldwide insurance approved King Air Flight School and Turbo-Prop flight training (inflight and simulator) for initial, recurrent and transition pilots.</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>CollectedN</th>
      <td>2</td>
      <td>Various News, Videos, Opinions.</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>BloggerMe3</th>
      <td>2</td>
      <td>@Steveirons edits a blog site interested in the future shape of Australia. Get involved. Make a blog. Visit your hometown. http://www.pinterest.com/bloggerme</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>Moya_Monia</th>
      <td>2</td>
      <td>"If you can do what you do best and be happy, you're further along in life than most people."</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>RPMSports18</th>
      <td>2</td>
      <td>24. University of South Alabama Alum. Just living life in a city below sea level. If you're reading this, then I probably popped up on your timeline.</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>heskiwi94x</th>
      <td>2</td>
      <td>An adult fangirl &amp;attended too many concerts. #OneDirection #Belieber #Mixer #Arianator #Lovatic #The1975 #Sheerio etc. #WWATourPhilly #OTRAPhilly. I met 1/4</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>___13Dec</th>
      <td>2</td>
      <td>⠀⠀⠀⠀ ⠀⠀⠀⠀ ⠀⠀⠀⠀⠀⠀⠀⠀ ♡ ⠀⠀⠀⠀ ⠀⠀⠀⠀ ⠀⠀⠀ ⠀⠀⠀⠀ ⠀⠀⠀⠀TS. H. The1975 Kodaline Coldplay LANY OW⠀ ⠀⠀⠀ Linkinpark Troye Sivan Singto&amp;Krist. PERAYA.⠀⠀⠀ ⠀⠀⠀⠀ ⠀⠀⠀⠀</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>billsplacehere</th>
      <td>2</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>Spotiflynet</th>
      <td>2</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>pdougmc</th>
      <td>2</td>
      <td>Retired, Interests: Gardening, photography, classical music, Astronomy, bicycling, Politics</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>DaveDuFourNBA</th>
      <td>2</td>
      <td>Basketball Coach, Host "On the NBA with Dave DuFour", Contributor at @RealGM &amp; @bballbreakdown\n\nCheck out my @Twitch channel https://www.twitch.tv/davedufournba</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>remypost</th>
      <td>2</td>
      <td>im remy | he/him | 22 | i love videogames | im the ana main ur parents warned you about | i also make games/art: @remyripple | WIPs/sketches: @scissorskid</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>EdyAntal</th>
      <td>2</td>
      <td>S A D  B O Y S</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>haneulvinkqq</th>
      <td>1</td>
      <td>안녕하세요 ~ 태국아미😁 🇹🇭แอคบ่น เพ้อ รีทุกอย่างที่ขวางหน้า ชอบหลายวง อยู่ด้อมอาร์มี่ รักบังทัน 🐯ชิปวีมิน🐥 *💸YOU NEVER เปย์ ALONE💸* Beyond The Scene - BTS</td>
      <td>NaN</td>
    </tr>
  </tbody>
</table>
</div></div>
<div class="section" id="time-series-plot">
<h2>Time series plot<a class="headerlink" href="#time-series-plot" title="Permalink to this headline">¶</a></h2>
<p>Doing time-series analysis with Twitter data will be covered in depth in
a subsequent post, but it&#8217;s worth introducing here. Another great way to
get a broader picture of our data is to understand when people are
Tweeting about these keywords. Now, recall that earlier we only grabbed
a tiny sample of data, so those Tweets only cover a few minutes of
activity&#8211;not a good way to build a time series. If you have access to
the enterprise level API, you will be able to make an API call to the
<a class="reference external" href="https://developer.twitter.com/en/docs/tweets/search/overview/enterprise">counts
endpoint</a>
to retrieve a time series <em>without</em> needing to use many calls to
retrieve all Tweets over a time period. Let&#8217;s try it out.</p>
<p><strong>Counts endpoint</strong></p>
<p>The counts endpoint has exactly the same API as the search endpoint, but
instead of returning Tweets, it returns counts of Tweets. This is
especially useful when you want to quickly assess a large dataset
without retrieving a lot of data.</p>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="c1"># use the same &quot;_rule&quot; string</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Recall, our rule is: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">_rule_a</span><span class="p">))</span>
<span class="n">count_rule_a</span> <span class="o">=</span> <span class="n">gen_rule_payload</span><span class="p">(</span><span class="n">_rule_a</span><span class="p">,</span>
                        <span class="n">from_date</span><span class="o">=</span><span class="s2">&quot;2017-07-01&quot;</span><span class="p">,</span>
                        <span class="n">to_date</span><span class="o">=</span><span class="s2">&quot;2017-08-01&quot;</span><span class="p">,</span>
                        <span class="n">results_per_call</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span>
                        <span class="n">count_bucket</span><span class="o">=</span><span class="s2">&quot;hour&quot;</span><span class="p">)</span>

<span class="n">counts_list</span> <span class="o">=</span> <span class="n">collect_results</span><span class="p">(</span><span class="n">count_rule_a</span><span class="p">,</span> <span class="n">max_results</span><span class="o">=</span><span class="mi">24</span><span class="o">*</span><span class="mi">31</span><span class="p">,</span> <span class="n">result_stream_args</span><span class="o">=</span><span class="n">search_args</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">Recall</span><span class="p">,</span> <span class="n">our</span> <span class="n">rule</span> <span class="ow">is</span><span class="p">:</span> <span class="p">(</span><span class="n">flying</span> <span class="n">OR</span> <span class="n">plane</span> <span class="n">OR</span> <span class="n">landed</span> <span class="n">OR</span> <span class="n">airport</span> <span class="n">OR</span> <span class="n">takeoff</span><span class="p">)</span>
</pre></div>
</div>
<p>The resulting counts payload is a list of counts and UTC timestamps.</p>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="n">counts_list</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">5</span><span class="p">]</span>
</pre></div>
</div>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="p">[{</span><span class="s1">&#39;count&#39;</span><span class="p">:</span> <span class="mi">9018</span><span class="p">,</span> <span class="s1">&#39;timePeriod&#39;</span><span class="p">:</span> <span class="s1">&#39;201707312300&#39;</span><span class="p">},</span>
 <span class="p">{</span><span class="s1">&#39;count&#39;</span><span class="p">:</span> <span class="mi">9900</span><span class="p">,</span> <span class="s1">&#39;timePeriod&#39;</span><span class="p">:</span> <span class="s1">&#39;201707312200&#39;</span><span class="p">},</span>
 <span class="p">{</span><span class="s1">&#39;count&#39;</span><span class="p">:</span> <span class="mi">9251</span><span class="p">,</span> <span class="s1">&#39;timePeriod&#39;</span><span class="p">:</span> <span class="s1">&#39;201707312100&#39;</span><span class="p">},</span>
 <span class="p">{</span><span class="s1">&#39;count&#39;</span><span class="p">:</span> <span class="mi">9829</span><span class="p">,</span> <span class="s1">&#39;timePeriod&#39;</span><span class="p">:</span> <span class="s1">&#39;201707312000&#39;</span><span class="p">},</span>
 <span class="p">{</span><span class="s1">&#39;count&#39;</span><span class="p">:</span> <span class="mi">9315</span><span class="p">,</span> <span class="s1">&#39;timePeriod&#39;</span><span class="p">:</span> <span class="s1">&#39;201707311900&#39;</span><span class="p">}]</span>
</pre></div>
</div>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="c1"># plot a timeseries of the Tweet counts</span>
<span class="n">tweet_counts_original</span> <span class="o">=</span> <span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">counts_list</span><span class="p">)</span>
     <span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">time_bucket</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="s2">&quot;timePeriod&quot;</span><span class="p">]))</span>
     <span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s2">&quot;timePeriod&quot;</span><span class="p">,</span><span class="n">axis</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span>
     <span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s2">&quot;time_bucket&quot;</span><span class="p">)</span>
     <span class="o">.</span><span class="n">sort_index</span><span class="p">()</span>
<span class="p">)</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">nrows</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span> <span class="o">=</span> <span class="p">(</span><span class="mi">15</span><span class="p">,</span><span class="mi">5</span><span class="p">))</span>
<span class="p">(</span><span class="n">tweet_counts_original</span>
 <span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
       <span class="n">title</span> <span class="o">=</span> <span class="s2">&quot;Count of Tweets per hour&quot;</span><span class="p">,</span>
       <span class="n">legend</span> <span class="o">=</span> <span class="kc">False</span><span class="p">));</span>
<span class="p">(</span><span class="n">tweet_counts_original</span>
 <span class="o">.</span><span class="n">resample</span><span class="p">(</span><span class="s2">&quot;D&quot;</span><span class="p">)</span>
 <span class="o">.</span><span class="n">sum</span><span class="p">()</span>
 <span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
       <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Count of Tweets per day&quot;</span><span class="p">,</span>
       <span class="n">legend</span><span class="o">=</span><span class="kc">False</span><span class="p">));</span>
</pre></div>
</div>
<img alt="_images/finding_the_right_data_51_0.png" src="_images/finding_the_right_data_51_0.png" />
<p><strong>How can we use this information to understand our search data?</strong></p>
<p>Consider the type of Tweets that we are looking for: we&#8217;re looking for
Tweets from people who are talking about air travel, hopefully people
talking about their own experiences using air travel. It&#8217;s pretty likely
that air travel has a relatively regular pattern, with probably some big
seasonal fluctuations (Thanksgiving?) and some daily fluctuations
(people fly, for the most part during the day); it&#8217;s unlikely that 2 or
3 times as many people fly on any given Monday vs the Mondays around it.</p>
<p>We can use an intuition about what spikes mean in our data to either
filter out high volume noise, or, in the case where spikes are what we
are seeking out (say we wanted the audience for a movie release that
happens on a specific day), zooming in on important time periods.</p>
<p>Let&#8217;s choose a few large spikes in this data and investigate further,
then exclude that topic from our final Twitter dataset.</p>
<div class="line-block">
<div class="line"><strong>Note:</strong></div>
<div class="line">If you don&#8217;t have access to the counts API, you should still take a
few small, time-boxed samples of data across the entire period of
interest and doing the same exercise. It&#8217;s harder to specifically
target spikes, but it will help you get a broader sample of data.</div>
</div>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="c1"># you can look at the plots to get a sense of what the highest-volume time periods are, or just sort your dataframe</span>
<span class="p">(</span><span class="n">tweet_counts_original</span>
 <span class="o">.</span><span class="n">resample</span><span class="p">(</span><span class="s2">&quot;D&quot;</span><span class="p">)</span>
 <span class="o">.</span><span class="n">sum</span><span class="p">()</span>
 <span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span> <span class="o">=</span> <span class="s2">&quot;count&quot;</span><span class="p">,</span> <span class="n">ascending</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span>
 <span class="o">.</span><span class="n">head</span><span class="p">())</span>
</pre></div>
</div>
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>count</th>
    </tr>
    <tr>
      <th>time_bucket</th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>2017-07-17</th>
      <td>334922</td>
    </tr>
    <tr>
      <th>2017-07-26</th>
      <td>301029</td>
    </tr>
    <tr>
      <th>2017-07-14</th>
      <td>286049</td>
    </tr>
    <tr>
      <th>2017-07-18</th>
      <td>276175</td>
    </tr>
    <tr>
      <th>2017-07-29</th>
      <td>259820</td>
    </tr>
  </tbody>
</table>
</div><div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="c1"># let&#39;s look at the highest volume day</span>
<span class="n">spike_rule_717</span> <span class="o">=</span> <span class="n">gen_rule_payload</span><span class="p">(</span><span class="n">_rule_a</span><span class="p">,</span>
                              <span class="n">from_date</span><span class="o">=</span><span class="s2">&quot;2017-07-17&quot;</span><span class="p">,</span>
                              <span class="n">to_date</span><span class="o">=</span><span class="s2">&quot;2017-07-18&quot;</span><span class="p">,</span>
                              <span class="n">results_per_call</span><span class="o">=</span><span class="mi">500</span><span class="p">)</span>

<span class="n">spike_results_list_717</span> <span class="o">=</span> <span class="n">collect_results</span><span class="p">(</span><span class="n">spike_rule_717</span><span class="p">,</span> <span class="n">max_results</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span> <span class="n">result_stream_args</span><span class="o">=</span><span class="n">search_args</span><span class="p">)</span>
</pre></div>
</div>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="c1"># what are these Tweets about?</span>
<span class="n">get_frequent_terms</span><span class="p">([</span><span class="n">x</span><span class="o">.</span><span class="n">all_text</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">spike_results_list_717</span><span class="p">],</span>
                   <span class="n">stop_words</span> <span class="o">=</span> <span class="s2">&quot;english&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span>
</pre></div>
</div>
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>count</th>
    </tr>
    <tr>
      <th>token</th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>got</th>
      <td>459</td>
    </tr>
    <tr>
      <th>flying</th>
      <td>273</td>
    </tr>
    <tr>
      <th>security</th>
      <td>228</td>
    </tr>
    <tr>
      <th>instead</th>
      <td>227</td>
    </tr>
    <tr>
      <th>flying cars</th>
      <td>225</td>
    </tr>
    <tr>
      <th>cars</th>
      <td>225</td>
    </tr>
    <tr>
      <th>office</th>
      <td>224</td>
    </tr>
    <tr>
      <th>robot drowned</th>
      <td>223</td>
    </tr>
    <tr>
      <th>got suicidal</th>
      <td>223</td>
    </tr>
    <tr>
      <th>drowned promised</th>
      <td>223</td>
    </tr>
    <tr>
      <th>building got</th>
      <td>223</td>
    </tr>
    <tr>
      <th>building</th>
      <td>223</td>
    </tr>
    <tr>
      <th>office building</th>
      <td>223</td>
    </tr>
    <tr>
      <th>got security</th>
      <td>223</td>
    </tr>
    <tr>
      <th>robots</th>
      <td>223</td>
    </tr>
    <tr>
      <th>instead got</th>
      <td>223</td>
    </tr>
    <tr>
      <th>suicidal</th>
      <td>223</td>
    </tr>
    <tr>
      <th>drowned</th>
      <td>223</td>
    </tr>
    <tr>
      <th>suicidal robots</th>
      <td>223</td>
    </tr>
    <tr>
      <th>security robot</th>
      <td>223</td>
    </tr>
  </tbody>
</table>
</div><div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="c1"># It&#39;s sometimes important to get the context of a full Tweet</span>
<span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">all_text</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">spike_results_list_717</span> <span class="k">if</span> <span class="s2">&quot;drowned&quot;</span> <span class="ow">in</span> <span class="n">x</span><span class="o">.</span><span class="n">all_text</span><span class="o">.</span><span class="n">lower</span><span class="p">()][</span><span class="mi">0</span><span class="p">:</span><span class="mi">10</span><span class="p">]</span>
</pre></div>
</div>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="p">[</span><span class="s1">&#39;Our D.C. office building got a security robot. It drowned itself.</span><span class="se">\n\n</span><span class="s1">We were promised flying cars, instead we got suicidal robots. https://t.co/rGLTAWZMjn&#39;</span><span class="p">,</span>
 <span class="s1">&#39;Our D.C. office building got a security robot. It drowned itself.</span><span class="se">\n\n</span><span class="s1">We were promised flying cars, instead we got suicidal robots. https://t.co/rGLTAWZMjn&#39;</span><span class="p">,</span>
 <span class="s1">&#39;Our D.C. office building got a security robot. It drowned itself.</span><span class="se">\n\n</span><span class="s1">We were promised flying cars, instead we got suicidal robots. https://t.co/rGLTAWZMjn&#39;</span><span class="p">,</span>
 <span class="s1">&#39;Our D.C. office building got a security robot. It drowned itself.</span><span class="se">\n\n</span><span class="s1">We were promised flying cars, instead we got suicidal robots. https://t.co/rGLTAWZMjn&#39;</span><span class="p">,</span>
 <span class="s1">&#39;Our D.C. office building got a security robot. It drowned itself.</span><span class="se">\n\n</span><span class="s1">We were promised flying cars, instead we got suicidal robots. https://t.co/rGLTAWZMjn&#39;</span><span class="p">,</span>
 <span class="s1">&#39;Our D.C. office building got a security robot. It drowned itself.</span><span class="se">\n\n</span><span class="s1">We were promised flying cars, instead we got suicidal robots. https://t.co/rGLTAWZMjn&#39;</span><span class="p">,</span>
 <span class="s1">&#39;Our D.C. office building got a security robot. It drowned itself.</span><span class="se">\n\n</span><span class="s1">We were promised flying cars, instead we got suicidal robots. https://t.co/rGLTAWZMjn&#39;</span><span class="p">,</span>
 <span class="s1">&#39;Our D.C. office building got a security robot. It drowned itself.</span><span class="se">\n\n</span><span class="s1">We were promised flying cars, instead we got suicidal robots. https://t.co/rGLTAWZMjn&#39;</span><span class="p">,</span>
 <span class="s1">&#39;Our D.C. office building got a security robot. It drowned itself.</span><span class="se">\n\n</span><span class="s1">We were promised flying cars, instead we got suicidal robots. https://t.co/rGLTAWZMjn&#39;</span><span class="p">,</span>
 <span class="s1">&#39;Our D.C. office building got a security robot. It drowned itself.</span><span class="se">\n\n</span><span class="s1">We were promised flying cars, instead we got suicidal robots. https://t.co/rGLTAWZMjn&#39;</span><span class="p">]</span>
</pre></div>
</div>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="c1"># let&#39;s look at the highest volume day</span>
<span class="n">spike_rule_726</span> <span class="o">=</span> <span class="n">gen_rule_payload</span><span class="p">(</span><span class="n">_rule_a</span><span class="p">,</span>
                              <span class="n">from_date</span><span class="o">=</span><span class="s2">&quot;2017-07-26&quot;</span><span class="p">,</span>
                              <span class="n">to_date</span><span class="o">=</span><span class="s2">&quot;2017-07-27&quot;</span><span class="p">,</span>
                              <span class="n">results_per_call</span><span class="o">=</span><span class="mi">500</span><span class="p">)</span>

<span class="n">spike_results_list_726</span> <span class="o">=</span> <span class="n">collect_results</span><span class="p">(</span><span class="n">spike_rule_726</span><span class="p">,</span> <span class="n">max_results</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span> <span class="n">result_stream_args</span><span class="o">=</span><span class="n">search_args</span><span class="p">)</span>
</pre></div>
</div>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="n">get_frequent_terms</span><span class="p">([</span><span class="n">x</span><span class="o">.</span><span class="n">all_text</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">spike_results_list_726</span><span class="p">],</span> <span class="n">stop_words</span> <span class="o">=</span> <span class="s2">&quot;english&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span>
</pre></div>
</div>
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>count</th>
    </tr>
    <tr>
      <th>token</th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>airport</th>
      <td>264</td>
    </tr>
    <tr>
      <th>plane</th>
      <td>124</td>
    </tr>
    <tr>
      <th>gimpo</th>
      <td>111</td>
    </tr>
    <tr>
      <th>gimpo airport</th>
      <td>106</td>
    </tr>
    <tr>
      <th>tokyo</th>
      <td>69</td>
    </tr>
    <tr>
      <th>flying</th>
      <td>68</td>
    </tr>
    <tr>
      <th>airport tokyo</th>
      <td>59</td>
    </tr>
    <tr>
      <th>preview</th>
      <td>58</td>
    </tr>
    <tr>
      <th>crash</th>
      <td>56</td>
    </tr>
    <tr>
      <th>sooyoung</th>
      <td>56</td>
    </tr>
    <tr>
      <th>seohyun</th>
      <td>55</td>
    </tr>
    <tr>
      <th>small</th>
      <td>49</td>
    </tr>
    <tr>
      <th>utah</th>
      <td>49</td>
    </tr>
    <tr>
      <th>small plane</th>
      <td>48</td>
    </tr>
    <tr>
      <th>crash utah</th>
      <td>46</td>
    </tr>
    <tr>
      <th>highway</th>
      <td>46</td>
    </tr>
    <tr>
      <th>#news</th>
      <td>46</td>
    </tr>
    <tr>
      <th>die</th>
      <td>45</td>
    </tr>
    <tr>
      <th>highway https://t.co/sizpfmclq7</th>
      <td>45</td>
    </tr>
    <tr>
      <th>#news #almalki</th>
      <td>45</td>
    </tr>
  </tbody>
</table>
</div><div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="p">[(</span><span class="n">x</span><span class="o">.</span><span class="n">all_text</span><span class="p">,</span> <span class="n">x</span><span class="o">.</span><span class="n">tweet_type</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">spike_results_list_726</span> <span class="k">if</span> <span class="s2">&quot;gimpo&quot;</span> <span class="ow">in</span> <span class="n">x</span><span class="o">.</span><span class="n">all_text</span><span class="o">.</span><span class="n">lower</span><span class="p">()][</span><span class="mi">0</span><span class="p">:</span><span class="mi">10</span><span class="p">]</span>
</pre></div>
</div>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="p">[(</span><span class="s1">&#39;[HD PIC] 170726 Gimpo Airport - Our boys Eunhyuk, Leeteuk and Donghae looking so good in their airport fashion! [3P] (Cr:As Tagged) https://t.co/tKCT7QApsh&#39;</span><span class="p">,</span>
  <span class="s1">&#39;retweet&#39;</span><span class="p">),</span>
 <span class="p">(</span><span class="s1">&#39;170726 Gimpo Airport #Donghae [卡卡_kaka_KAKA] https://t.co/UIAgC2SroA&#39;</span><span class="p">,</span>
  <span class="s1">&#39;retweet&#39;</span><span class="p">),</span>
 <span class="p">(</span><span class="s1">&#39;[Preview] 170727 Seohyun - Gimpo airport by seohyuntwunion https://t.co/klNNEAf5Ko&#39;</span><span class="p">,</span>
  <span class="s1">&#39;retweet&#39;</span><span class="p">),</span>
 <span class="p">(</span><span class="s1">&#39;[Preview] 170727 Sooyoung - Gimpo airport by jtt_muk https://t.co/uKrcF8lmNe&#39;</span><span class="p">,</span>
  <span class="s1">&#39;retweet&#39;</span><span class="p">),</span>
 <span class="p">(</span><span class="s1">&#39;[Preview] 170727 Sooyoung - Gimpo airport by jtt_muk https://t.co/uKrcF8lmNe&#39;</span><span class="p">,</span>
  <span class="s1">&#39;retweet&#39;</span><span class="p">),</span>
 <span class="p">(</span><span class="s1">&#39;[Preview] 170727 Seohyun - Gimpo airport by mr_zhang https://t.co/5gAgwJZudT&#39;</span><span class="p">,</span>
  <span class="s1">&#39;retweet&#39;</span><span class="p">),</span>
 <span class="p">(</span><span class="s1">&#39;[PRESS] 170726 Mark at Gimpo airport departures to Tokyo, Japan (2) https://t.co/urWfCgwWJZ&#39;</span><span class="p">,</span>
  <span class="s1">&#39;tweet&#39;</span><span class="p">),</span>
 <span class="p">(</span><span class="s1">&#39;170726 Gimpo airport to Tokyo - Taeyong press pics #NCT127 #태용 https://t.co/qV3jfRdFuy&#39;</span><span class="p">,</span>
  <span class="s1">&#39;retweet&#39;</span><span class="p">),</span>
 <span class="p">(</span><span class="s1">&#39;170727 Heechul, Shindong at Gimpo Airport going to Japan for #SMTOWNLIVEinTokyo https://t.co/YWHSgX1XZW&#39;</span><span class="p">,</span>
  <span class="s1">&#39;retweet&#39;</span><span class="p">),</span>
 <span class="p">(</span><span class="s1">&#39;170727 Gimpo Airport</span><span class="se">\n\n</span><span class="s1">#KimHeechul #Heechul #김희철 #희철</span><span class="se">\n\n</span><span class="s1">[特纸SAMA和希大人一起niconiconi] https://t.co/OJgH9EKSSC&#39;</span><span class="p">,</span>
  <span class="s1">&#39;retweet&#39;</span><span class="p">)]</span>
</pre></div>
</div>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="p">[(</span><span class="n">x</span><span class="o">.</span><span class="n">all_text</span><span class="p">,</span> <span class="n">x</span><span class="o">.</span><span class="n">tweet_type</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">spike_results_list_726</span> <span class="k">if</span> <span class="s2">&quot;utah&quot;</span> <span class="ow">in</span> <span class="n">x</span><span class="o">.</span><span class="n">all_text</span><span class="o">.</span><span class="n">lower</span><span class="p">()][</span><span class="mi">0</span><span class="p">:</span><span class="mi">10</span><span class="p">]</span>
</pre></div>
</div>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="p">[(</span><span class="s1">&#39;#News by #almalki : Four aboard small plane die in crash on Utah highway https://t.co/sizPfmclq7&#39;</span><span class="p">,</span>
  <span class="s1">&#39;retweet&#39;</span><span class="p">),</span>
 <span class="p">(</span><span class="s1">&#39;#News by #almalki : Four aboard small plane die in crash on Utah highway https://t.co/sizPfmclq7&#39;</span><span class="p">,</span>
  <span class="s1">&#39;retweet&#39;</span><span class="p">),</span>
 <span class="p">(</span><span class="s1">&#39;#News by #almalki : Four aboard small plane die in crash on Utah highway https://t.co/sizPfmclq7&#39;</span><span class="p">,</span>
  <span class="s1">&#39;retweet&#39;</span><span class="p">),</span>
 <span class="p">(</span><span class="s1">&#39;#News by #almalki : Four aboard small plane die in crash on Utah highway https://t.co/sizPfmclq7&#39;</span><span class="p">,</span>
  <span class="s1">&#39;retweet&#39;</span><span class="p">),</span>
 <span class="p">(</span><span class="s1">&#39;#News by #almalki : Four aboard small plane die in crash on Utah highway https://t.co/sizPfmclq7&#39;</span><span class="p">,</span>
  <span class="s1">&#39;retweet&#39;</span><span class="p">),</span>
 <span class="p">(</span><span class="s1">&#39;#News by #almalki : Four aboard small plane die in crash on Utah highway https://t.co/sizPfmclq7&#39;</span><span class="p">,</span>
  <span class="s1">&#39;retweet&#39;</span><span class="p">),</span>
 <span class="p">(</span><span class="s1">&#39;#News by #almalki : Four aboard small plane die in crash on Utah highway https://t.co/sizPfmclq7&#39;</span><span class="p">,</span>
  <span class="s1">&#39;retweet&#39;</span><span class="p">),</span>
 <span class="p">(</span><span class="s1">&#39;#News by #almalki : Four aboard small plane die in crash on Utah highway https://t.co/sizPfmclq7&#39;</span><span class="p">,</span>
  <span class="s1">&#39;retweet&#39;</span><span class="p">),</span>
 <span class="p">(</span><span class="s1">&#39;#News by #almalki : Four aboard small plane die in crash on Utah highway https://t.co/sizPfmclq7&#39;</span><span class="p">,</span>
  <span class="s1">&#39;retweet&#39;</span><span class="p">),</span>
 <span class="p">(</span><span class="s1">&#39;#News by #almalki : Four aboard small plane die in crash on Utah highway https://t.co/sizPfmclq7&#39;</span><span class="p">,</span>
  <span class="s1">&#39;retweet&#39;</span><span class="p">)]</span>
</pre></div>
</div>
</div>
<div class="section" id="iterate">
<h2>3. Iterate<a class="headerlink" href="#iterate" title="Permalink to this headline">¶</a></h2>
</div>
<div class="section" id="now-that-we-understand-what-we-re-matching-on">
<h2>Now that we understand what we&#8217;re matching on<a class="headerlink" href="#now-that-we-understand-what-we-re-matching-on" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><strong>Exclusions</strong>: The most important part of refining rules is often
excluding Tweets that are irrelevant. Earlier, we learned that the
Search API provides a negation operator (the &#8220;<code class="docutils literal"><span class="pre">-</span></code>&#8221; operator), which
you should use for exclusions. Use the &#8220;<code class="docutils literal"><span class="pre">-</span></code>&#8221; operator to exclude
terms that show up in irrelevant spikes, to exclude certain kinds of
Tweets (say, exclude Retweets), or anything else that might mark a
Tweet as irrelevant (spammy hashtags, news articles that aren&#8217;t
interesting, etc).</li>
<li><strong>Advanced operators</strong>: So far we have only covered token matching
operators. There are more advanced operators, which can be used to
match different aspects of a Tweet (is is a Retweet? does it contain
an image?) or words in different parts of the payload (does the
string &#8220;cnn&#8221; appear in a link? does the phrase &#8220;soccer mom&#8221; appear in
the bio?). We&#8217;ll show a few examples of using those operators in this
section&#8211;for a complete list, read our <a class="reference external" href="https://developer.twitter.com/en/docs/tweets/rules-and-filtering/overview/premium-operators">operator
documentation</a>.</li>
</ul>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="c1"># expand based on what you see (these are top terms that didn&#39;t seem relevant, look at the frequent terms we saw)</span>
<span class="n">_rule_b</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">(plane OR landed OR airport OR takeoff OR #wheelsup)</span>
<span class="s2">-is:retweet</span>
<span class="s2">-trump</span>
<span class="s2">-harry</span>
<span class="s2">-drowned</span>
<span class="s2">-g20</span>
<span class="s2">-lawyer</span>
<span class="s2">-gimpo</span>
<span class="s2">-fuck</span>
<span class="s2">&quot;&quot;&quot;</span>

<span class="n">rule_b</span> <span class="o">=</span> <span class="n">gen_rule_payload</span><span class="p">(</span><span class="n">_rule_b</span><span class="p">,</span>
                          <span class="n">from_date</span><span class="o">=</span><span class="s2">&quot;2017-07-01&quot;</span><span class="p">,</span>
                          <span class="n">to_date</span><span class="o">=</span><span class="s2">&quot;2017-08-01&quot;</span><span class="p">,</span>
                          <span class="n">results_per_call</span><span class="o">=</span><span class="mi">500</span><span class="p">)</span>

<span class="n">results_list</span> <span class="o">=</span> <span class="n">collect_results</span><span class="p">(</span><span class="n">rule_b</span><span class="p">,</span> <span class="n">max_results</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span> <span class="n">result_stream_args</span><span class="o">=</span><span class="n">search_args</span><span class="p">)</span>
</pre></div>
</div>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="c1"># look at frequent terms again</span>
<span class="n">get_frequent_terms</span><span class="p">([</span><span class="n">x</span><span class="o">.</span><span class="n">all_text</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">results_list</span><span class="p">],</span> <span class="n">stop_words</span> <span class="o">=</span> <span class="s2">&quot;english&quot;</span><span class="p">,</span> <span class="n">ngram_range</span> <span class="o">=</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span>
</pre></div>
</div>
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>count</th>
    </tr>
    <tr>
      <th>token</th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>international airport</th>
      <td>26</td>
    </tr>
    <tr>
      <th>just landed</th>
      <td>11</td>
    </tr>
    <tr>
      <th>airport worker</th>
      <td>10</td>
    </tr>
    <tr>
      <th>easyjet passenger</th>
      <td>10</td>
    </tr>
    <tr>
      <th>airport security</th>
      <td>9</td>
    </tr>
    <tr>
      <th>plane crashes</th>
      <td>8</td>
    </tr>
    <tr>
      <th>plane crash</th>
      <td>8</td>
    </tr>
    <tr>
      <th>punches easyjet passenger</th>
      <td>7</td>
    </tr>
    <tr>
      <th>punches easyjet</th>
      <td>7</td>
    </tr>
    <tr>
      <th>passenger holding</th>
      <td>7</td>
    </tr>
    <tr>
      <th>crashes mississippi killing</th>
      <td>6</td>
    </tr>
    <tr>
      <th>mississippi killing</th>
      <td>6</td>
    </tr>
    <tr>
      <th>crashes mississippi</th>
      <td>6</td>
    </tr>
    <tr>
      <th>military plane crashes</th>
      <td>6</td>
    </tr>
    <tr>
      <th>plane crashes mississippi</th>
      <td>6</td>
    </tr>
    <tr>
      <th>mississippi killing people</th>
      <td>6</td>
    </tr>
    <tr>
      <th>military plane</th>
      <td>6</td>
    </tr>
    <tr>
      <th>killing people</th>
      <td>6</td>
    </tr>
    <tr>
      <th>plane ride</th>
      <td>5</td>
    </tr>
    <tr>
      <th>new york</th>
      <td>5</td>
    </tr>
  </tbody>
</table>
</div><div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="c1"># use the same &quot;_rule&quot; string</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Recall, our rule is: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">_rule_b</span><span class="p">))</span>
<span class="n">count_rule_b</span> <span class="o">=</span> <span class="n">gen_rule_payload</span><span class="p">(</span><span class="n">_rule_b</span><span class="p">,</span>
                        <span class="n">from_date</span><span class="o">=</span><span class="s2">&quot;2017-07-01&quot;</span><span class="p">,</span>
                        <span class="n">to_date</span><span class="o">=</span><span class="s2">&quot;2017-08-01&quot;</span><span class="p">,</span>
                        <span class="n">count_bucket</span><span class="o">=</span><span class="s2">&quot;hour&quot;</span><span class="p">)</span>

<span class="n">counts_list</span> <span class="o">=</span> <span class="n">collect_results</span><span class="p">(</span><span class="n">count_rule_b</span><span class="p">,</span> <span class="n">max_results</span><span class="o">=</span><span class="mi">24</span><span class="o">*</span><span class="mi">31</span><span class="p">,</span> <span class="n">result_stream_args</span><span class="o">=</span><span class="n">search_args</span><span class="p">)</span>

<span class="c1"># plot a timeseries of the Tweet counts</span>
<span class="n">tweet_counts</span> <span class="o">=</span> <span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">counts_list</span><span class="p">)</span>
                <span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">time_bucket</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="s2">&quot;timePeriod&quot;</span><span class="p">]))</span>
                <span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s2">&quot;timePeriod&quot;</span><span class="p">,</span><span class="n">axis</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span>
                <span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s2">&quot;time_bucket&quot;</span><span class="p">)</span>
                <span class="o">.</span><span class="n">sort_index</span><span class="p">())</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">nrows</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span> <span class="o">=</span> <span class="p">(</span><span class="mi">15</span><span class="p">,</span><span class="mi">5</span><span class="p">))</span>
<span class="p">(</span><span class="n">tweet_counts</span>
 <span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
       <span class="n">title</span> <span class="o">=</span> <span class="s2">&quot;Count of Tweets per hour&quot;</span><span class="p">,</span> <span class="n">legend</span> <span class="o">=</span> <span class="kc">False</span><span class="p">));</span>
<span class="p">(</span><span class="n">tweet_counts</span>
 <span class="o">.</span><span class="n">resample</span><span class="p">(</span><span class="s2">&quot;D&quot;</span><span class="p">)</span>
 <span class="o">.</span><span class="n">sum</span><span class="p">()</span>
 <span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
       <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Count of Tweets per day&quot;</span><span class="p">,</span>
       <span class="n">legend</span><span class="o">=</span><span class="kc">False</span><span class="p">));</span>
</pre></div>
</div>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">Recall</span><span class="p">,</span> <span class="n">our</span> <span class="n">rule</span> <span class="ow">is</span><span class="p">:</span>
<span class="p">(</span><span class="n">plane</span> <span class="n">OR</span> <span class="n">landed</span> <span class="n">OR</span> <span class="n">airport</span> <span class="n">OR</span> <span class="n">takeoff</span> <span class="n">OR</span> <span class="c1">#wheelsup)</span>
<span class="o">-</span><span class="ow">is</span><span class="p">:</span><span class="n">retweet</span>
<span class="o">-</span><span class="n">trump</span>
<span class="o">-</span><span class="n">harry</span>
<span class="o">-</span><span class="n">drowned</span>
<span class="o">-</span><span class="n">g20</span>
<span class="o">-</span><span class="n">lawyer</span>
<span class="o">-</span><span class="n">gimpo</span>
<span class="o">-</span><span class="n">fuck</span>
</pre></div>
</div>
<img alt="_images/finding_the_right_data_64_1.png" src="_images/finding_the_right_data_64_1.png" />
</div>
<div class="section" id="look-at-that-regular-timeseries">
<h2>Look at that regular timeseries!<a class="headerlink" href="#look-at-that-regular-timeseries" title="Permalink to this headline">¶</a></h2>
<p>Remember when we noted that the Tweet timeseries around flying is
unlikely to have big, irregular spikes? It seems like we got rid of most
of them, save one or two. Let&#8217;s look into those last spikes and exclude
those too.</p>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="c1"># let&#39;s look at the highest volume day</span>
<span class="n">spike_rule_711</span> <span class="o">=</span> <span class="n">gen_rule_payload</span><span class="p">(</span><span class="n">_rule_b</span><span class="p">,</span>
                                  <span class="n">from_date</span><span class="o">=</span><span class="s2">&quot;2017-07-11&quot;</span><span class="p">,</span>
                                  <span class="n">to_date</span><span class="o">=</span><span class="s2">&quot;2017-07-12&quot;</span><span class="p">,</span>
                                  <span class="p">)</span>

<span class="c1"># force results to evaluate (this step actually makes the API calls)</span>
<span class="n">spike_results_list_711</span> <span class="o">=</span> <span class="n">collect_results</span><span class="p">(</span><span class="n">spike_rule_711</span><span class="p">,</span> <span class="n">max_results</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span> <span class="n">result_stream_args</span><span class="o">=</span><span class="n">search_args</span><span class="p">)</span>
</pre></div>
</div>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="n">get_frequent_terms</span><span class="p">([</span><span class="n">x</span><span class="o">.</span><span class="n">all_text</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">spike_results_list_711</span><span class="p">],</span>
                   <span class="n">stop_words</span><span class="o">=</span><span class="s2">&quot;english&quot;</span><span class="p">,</span>
                   <span class="n">ngram_range</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">15</span><span class="p">)</span>
</pre></div>
</div>
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>count</th>
    </tr>
    <tr>
      <th>token</th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>plane</th>
      <td>244</td>
    </tr>
    <tr>
      <th>airport</th>
      <td>195</td>
    </tr>
    <tr>
      <th>crash</th>
      <td>62</td>
    </tr>
    <tr>
      <th>landed</th>
      <td>48</td>
    </tr>
    <tr>
      <th>mississippi</th>
      <td>42</td>
    </tr>
    <tr>
      <th>marine</th>
      <td>39</td>
    </tr>
    <tr>
      <th>international</th>
      <td>38</td>
    </tr>
    <tr>
      <th>i'm</th>
      <td>37</td>
    </tr>
    <tr>
      <th>killed</th>
      <td>35</td>
    </tr>
    <tr>
      <th>vermont</th>
      <td>29</td>
    </tr>
    <tr>
      <th>taxiway</th>
      <td>25</td>
    </tr>
    <tr>
      <th>flight</th>
      <td>23</td>
    </tr>
    <tr>
      <th>just</th>
      <td>22</td>
    </tr>
    <tr>
      <th>san</th>
      <td>21</td>
    </tr>
    <tr>
      <th>lands</th>
      <td>19</td>
    </tr>
  </tbody>
</table>
</div></div>
<div class="section" id="frequent-terms-vs-frequent-n-grams">
<h2>Frequent terms vs frequent &#8220;n-grams&#8221;<a class="headerlink" href="#frequent-terms-vs-frequent-n-grams" title="Permalink to this headline">¶</a></h2>
<p>We&#8217;ve talked about using frequent terms to identify what a corpus of
Tweets is about, but I want to mention frequent &#8220;n-grams&#8221; as a slightly
more sophisticated alternative.</p>
<p><strong>n-gram</strong>: a sequence of <em>n</em> tokens from a document</p>
<p>Using frequent n-grams, you might be able to identify when words show
together, in the same sequence surprisingly often - potentially
indicating spam, promotional material, memes, lyrics, or reposted
content. Pay attention to words that appear together, and you can
exclude an n-gram by excluding an &#8220;exact phrase&#8221; from your Search query.</p>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="c1"># let&#39;s look at 2- and 3- grams</span>
<span class="n">get_frequent_terms</span><span class="p">([</span><span class="n">x</span><span class="o">.</span><span class="n">all_text</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">spike_results_list_711</span><span class="p">],</span>
                   <span class="n">stop_words</span> <span class="o">=</span> <span class="s2">&quot;english&quot;</span><span class="p">,</span>
                   <span class="n">ngram_range</span> <span class="o">=</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span>
</pre></div>
</div>
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>count</th>
    </tr>
    <tr>
      <th>token</th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>plane crash</th>
      <td>58</td>
    </tr>
    <tr>
      <th>international airport</th>
      <td>37</td>
    </tr>
    <tr>
      <th>mississippi plane</th>
      <td>30</td>
    </tr>
    <tr>
      <th>mississippi plane crash</th>
      <td>30</td>
    </tr>
    <tr>
      <th>killed mississippi</th>
      <td>29</td>
    </tr>
    <tr>
      <th>marine vermont killed</th>
      <td>29</td>
    </tr>
    <tr>
      <th>marine vermont</th>
      <td>29</td>
    </tr>
    <tr>
      <th>vermont killed</th>
      <td>29</td>
    </tr>
    <tr>
      <th>vermont killed mississippi</th>
      <td>29</td>
    </tr>
    <tr>
      <th>killed mississippi plane</th>
      <td>29</td>
    </tr>
    <tr>
      <th>san francisco</th>
      <td>17</td>
    </tr>
    <tr>
      <th>nearly lands</th>
      <td>14</td>
    </tr>
    <tr>
      <th>military plane</th>
      <td>12</td>
    </tr>
    <tr>
      <th>lands crowded</th>
      <td>11</td>
    </tr>
    <tr>
      <th>crowded taxiway</th>
      <td>11</td>
    </tr>
    <tr>
      <th>plane ticket</th>
      <td>11</td>
    </tr>
    <tr>
      <th>air canada</th>
      <td>11</td>
    </tr>
    <tr>
      <th>lands crowded taxiway</th>
      <td>11</td>
    </tr>
    <tr>
      <th>greatest aviation</th>
      <td>10</td>
    </tr>
    <tr>
      <th>greatest aviation disaster</th>
      <td>10</td>
    </tr>
  </tbody>
</table>
</div><p>In this data, we can see that <code class="docutils literal"><span class="pre">&quot;mississippi</span> <span class="pre">plane</span> <span class="pre">crash&quot;</span></code>,
<code class="docutils literal"><span class="pre">&quot;killed</span> <span class="pre">mississippi</span> <span class="pre">plane</span>&#160;&#160; <span class="pre">&quot;</span></code>, &#8220;vermont killed mississippi&#8221; all show
up frequently, and they all show up <em>the same number of times</em>. Let me
find one of those Tweets to look at:</p>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">all_text</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">spike_results_list_711</span> <span class="k">if</span> <span class="s2">&quot;vermont&quot;</span> <span class="ow">in</span> <span class="n">x</span><span class="o">.</span><span class="n">all_text</span><span class="o">.</span><span class="n">lower</span><span class="p">()][</span><span class="mi">0</span><span class="p">:</span><span class="mi">5</span><span class="p">]</span>
</pre></div>
</div>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="p">[</span><span class="s1">&#39;Marine from Vermont killed in Mississippi plane</span><span class="se">\xa0</span><span class="s1">crash https://t.co/RGnRfCI0lg&#39;</span><span class="p">,</span>
 <span class="s1">&#39;KMBC  @kmbc</span><span class="se">\n</span><span class="s1"> Marine from Vermont killed in Mississippi plane crash https://t.co/DirY01X2Pd https://t.co/QTaRr1JkNQ&#39;</span><span class="p">,</span>
 <span class="s1">&#39;Pittsburgh News Marine from Vermont killed in Mississippi plane crash https://t.co/dk71SLzkm5 https://t.co/JfgXcdO1yR&#39;</span><span class="p">,</span>
 <span class="s1">&#39;Marine from Vermont killed in Mississippi plane crash https://t.co/HvjlG7vp6W https://t.co/Ij4MCBBFQn&#39;</span><span class="p">,</span>
 <span class="s1">&#39;Marine from Vermont killed in Mississippi plane crash https://t.co/7hSTiZxMmX https://t.co/irB0fdy6Vs&#39;</span><span class="p">]</span>
</pre></div>
</div>
<p>Doesn&#8217;t have much to do with the experience of flying in a plane. Let&#8217;s
exclude it. In this case, we might exclude these Tweets pretty precisely
by excluding &#8220;Marine&#8221; (it&#8217;s good to pick specific, unambiguous terms for
exclusions, so that you don&#8217;t do anything too broad), but for this
example we&#8217;ll exclude &#8220;plane crash&#8221;&#8211;it&#8217;s precise enough, will exclude
other similar news-type content, and we can demonstrate exact phrase
matching.</p>
<p>Add this to my rule: <code class="docutils literal"><span class="pre">-&quot;plane</span> <span class="pre">crash&quot;</span></code></p>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="c1"># expand based on what you see</span>
<span class="n">_rule_c</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">(plane OR landed OR airport OR takeoff OR #wheelsup)</span>
<span class="s2">-is:retweet</span>
<span class="s2">-trump</span>
<span class="s2">-harry</span>
<span class="s2">-drowned</span>
<span class="s2">-g20</span>
<span class="s2">-lawyer</span>
<span class="s2">-gimpo</span>
<span class="s2">-fuck</span>
<span class="s2">-&quot;plane crash&quot;</span>
<span class="s2">&quot;&quot;&quot;</span>

<span class="n">spike_rule_704</span> <span class="o">=</span> <span class="n">gen_rule_payload</span><span class="p">(</span><span class="n">_rule_c</span><span class="p">,</span>
                                  <span class="n">from_date</span><span class="o">=</span><span class="s2">&quot;2017-07-04&quot;</span><span class="p">,</span>
                                  <span class="n">to_date</span><span class="o">=</span><span class="s2">&quot;2017-07-05&quot;</span><span class="p">,</span>
                                  <span class="p">)</span>

<span class="n">spike_results_list_704</span> <span class="o">=</span> <span class="n">collect_results</span><span class="p">(</span><span class="n">spike_rule_704</span><span class="p">,</span> <span class="n">max_results</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span> <span class="n">result_stream_args</span><span class="o">=</span><span class="n">search_args</span><span class="p">)</span>
</pre></div>
</div>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="n">get_frequent_terms</span><span class="p">([</span><span class="n">x</span><span class="o">.</span><span class="n">all_text</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">spike_results_list_704</span><span class="p">],</span> <span class="n">stop_words</span> <span class="o">=</span> <span class="s2">&quot;english&quot;</span><span class="p">,</span> <span class="n">ngram_range</span> <span class="o">=</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span>
</pre></div>
</div>
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>count</th>
    </tr>
    <tr>
      <th>token</th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>hampton airport</th>
      <td>39</td>
    </tr>
    <tr>
      <th>citizens east hampton</th>
      <td>39</td>
    </tr>
    <tr>
      <th>east hampton</th>
      <td>39</td>
    </tr>
    <tr>
      <th>east hampton airport</th>
      <td>39</td>
    </tr>
    <tr>
      <th>citizens east</th>
      <td>39</td>
    </tr>
    <tr>
      <th>international airport</th>
      <td>30</td>
    </tr>
    <tr>
      <th>airport james</th>
      <td>29</td>
    </tr>
    <tr>
      <th>hampton airport james</th>
      <td>29</td>
    </tr>
    <tr>
      <th>james barron</th>
      <td>29</td>
    </tr>
    <tr>
      <th>airport james barron</th>
      <td>29</td>
    </tr>
    <tr>
      <th>barron nyt</th>
      <td>26</td>
    </tr>
    <tr>
      <th>james barron nyt</th>
      <td>26</td>
    </tr>
    <tr>
      <th>new york</th>
      <td>17</td>
    </tr>
    <tr>
      <th>#android #gameinsight</th>
      <td>16</td>
    </tr>
    <tr>
      <th>airport city</th>
      <td>15</td>
    </tr>
    <tr>
      <th>new york times</th>
      <td>14</td>
    </tr>
    <tr>
      <th>york times</th>
      <td>14</td>
    </tr>
    <tr>
      <th>nyt new york</th>
      <td>13</td>
    </tr>
    <tr>
      <th>nyt new</th>
      <td>13</td>
    </tr>
    <tr>
      <th>barron nyt new</th>
      <td>13</td>
    </tr>
  </tbody>
</table>
</div><p>Now, it&#8217;s not the top term, but when a specific hashtag shows up with
some frequency, it&#8217;s time take a look. Hashtags are often used to group
together topics, and by filtering the hashtag we could catch irrelevant
topics. Let&#8217;s look at &#8220;#gameinsight.&#8221;</p>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="c1"># try searching on the hashtag:</span>
<span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">all_text</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">spike_results_list_704</span> <span class="k">if</span> <span class="s2">&quot;gameinsight&quot;</span> <span class="ow">in</span> <span class="n">x</span><span class="o">.</span><span class="n">hashtags</span><span class="p">][</span><span class="mi">0</span><span class="p">:</span><span class="mi">5</span><span class="p">]</span>
</pre></div>
</div>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="p">[</span><span class="s1">&#39;¡He completado la misión Día Desafortunado en el juego Airport-City! https://t.co/Ya2oVyXXHo #android #gameinsight&#39;</span><span class="p">,</span>
 <span class="s1">&#39;¡He alcanzado el nivel 8 en el juego Airport-City! https://t.co/Ya2oVyXXHo #android #gameinsight&#39;</span><span class="p">,</span>
 <span class="s1">&#39;New plane in my Airport City: Turboprop! https://t.co/Ky4J5dMyBT #iOS #gameinsight&#39;</span><span class="p">,</span>
 <span class="s2">&quot;I&#39;ve completed Party Like You Mean It quest in Airport City! https://t.co/QaJ1PIehi7 #android #gameinsight&quot;</span><span class="p">,</span>
 <span class="s2">&quot;I&#39;ve completed A Chinese Torture quest in Airport City! https://t.co/QaJ1PIehi7 #android #gameinsight&quot;</span><span class="p">]</span>
</pre></div>
</div>
<p>Well, that looks like spam. Let&#8217;s exclude a hashtag this time: it&#8217;s
specific, seems to appear in this content, and easy to exclude. Use the
hashtag and negation operator in Search like this:</p>
<p>Add <code class="docutils literal"><span class="pre">-#gameinsight</span></code></p>
<p>Also, it&#8217;s not clear that &#8220;gameinsight&#8221; is all of this spike. Try
searching for &#8220;hampton&#8221; too (as it is one of the most common terms):</p>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">all_text</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">spike_results_list_704</span> <span class="k">if</span> <span class="s2">&quot;hampton&quot;</span> <span class="ow">in</span> <span class="n">x</span><span class="o">.</span><span class="n">all_text</span><span class="o">.</span><span class="n">lower</span><span class="p">()][</span><span class="mi">0</span><span class="p">:</span><span class="mi">5</span><span class="p">]</span>
</pre></div>
</div>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="p">[</span><span class="s1">&#39;The Citizens of East Hampton v. Its Airport https://t.co/xDRiyor0Ej&#39;</span><span class="p">,</span>
 <span class="s1">&#39;&quot;The Citizens of East Hampton v. Its Airport&quot; https://t.co/Fm6NOXqRen&#39;</span><span class="p">,</span>
 <span class="s1">&#39;&quot;The Citizens of East Hampton v. Its Airport&quot; by JAMES BARRON via NYT https://t.co/LAMg6kHkZN https://t.co/pHhMKTw8Kx&#39;</span><span class="p">,</span>
 <span class="s1">&#39;#3Novices : The Citizens of East Hampton v. Its Airport The Supreme Court’s refusal last week to review local restrictions on flights is th…&#39;</span><span class="p">,</span>
 <span class="s1">&#39;&quot;The Citizens of East Hampton v. Its Airport&quot; by JAMES BARRON via NYT https://t.co/eaW8rdnj4M&#39;</span><span class="p">]</span>
</pre></div>
</div>
<p>Now, could add: <code class="docutils literal"><span class="pre">-&quot;citizens</span> <span class="pre">of</span> <span class="pre">east</span> <span class="pre">hampton&quot;</span></code> and exclude this one
news story, but we might have identified a larger pattern.</p>
<p><strong>URL matching</strong></p>
<p>News stories about planes, crashes, etc are showing up a lot, and we do
not want to see any of them in the final dataset (again, this is
absolutely a choice, and it will eliminate a lot of data, for better or
for worse). We&#8217;re going to choose to exclude all Tweets with certain big
news URLs included in them. We&#8217;re not going to get this perfect here,
but we will see how to use the URL matching rule, and give you more
ideas about how to filter Tweets.</p>
<p>The <code class="docutils literal"><span class="pre">url:&lt;token&gt;</span></code> operator performs a tokenized match on words in the
unrolled URL that was posted in the Tweet. We&#8217;ll eliminate Tweets with:
&#8220;nytimes&#8221;,&#8221;bbc&#8221;,&#8221;washingtonpost&#8221;, &#8220;cbsnews&#8221;, &#8220;reuters&#8221;, &#8220;apnews&#8221;, and
&#8220;news&#8221; in the URL.</p>
<p>Add:
<code class="docutils literal"><span class="pre">-url:nytimes</span> <span class="pre">-url:bbc</span> <span class="pre">-url:washingtonpost</span> <span class="pre">-url:cbsnews</span> <span class="pre">-url:reuters</span> <span class="pre">-url:apnews</span> <span class="pre">-url:news</span></code></p>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="c1"># expand based on what you see</span>
<span class="n">_rule_d</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">(plane OR landed OR airport OR takeoff OR #wheelsup)</span>
<span class="s2">-is:retweet</span>
<span class="s2">-trump</span>
<span class="s2">-harry</span>
<span class="s2">-drowned</span>
<span class="s2">-g20</span>
<span class="s2">-lawyer</span>
<span class="s2">-gimpo</span>
<span class="s2">-fuck</span>
<span class="s2">-&quot;plane crash&quot;</span>
<span class="s2">-&quot;citizens of east hampton&quot;</span>
<span class="s2">-url:nytimes -url:bbc -url:washingtonpost -url:cbsnews -url:reuters -url:apnews -url:news</span>
<span class="s2">&quot;&quot;&quot;</span>
</pre></div>
</div>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="c1"># finally, let&#39;s look at that high volume hour on July 3rd</span>
<span class="n">tweet_counts</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span> <span class="o">=</span> <span class="s2">&quot;count&quot;</span><span class="p">,</span> <span class="n">ascending</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
</pre></div>
</div>
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>count</th>
    </tr>
    <tr>
      <th>time_bucket</th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>2017-07-03 18:00:00</th>
      <td>5058</td>
    </tr>
    <tr>
      <th>2017-07-03 19:00:00</th>
      <td>4458</td>
    </tr>
  </tbody>
</table>
</div><div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="n">spike_rule_703</span> <span class="o">=</span> <span class="n">gen_rule_payload</span><span class="p">(</span><span class="n">_rule_d</span><span class="p">,</span> <span class="c1">#&lt;-remember, same rule</span>
                                  <span class="n">from_date</span><span class="o">=</span><span class="s2">&quot;2017-07-03T18:00&quot;</span><span class="p">,</span>
                                  <span class="n">to_date</span><span class="o">=</span><span class="s2">&quot;2017-07-03T19:01&quot;</span><span class="p">,</span>
                                  <span class="p">)</span>

<span class="c1"># force results to evaluate (this step actually makes the API calls)</span>
<span class="n">spike_results_list_703</span> <span class="o">=</span> <span class="n">collect_results</span><span class="p">(</span><span class="n">spike_rule_703</span><span class="p">,</span> <span class="n">max_results</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span> <span class="n">result_stream_args</span><span class="o">=</span><span class="n">search_args</span><span class="p">)</span>
</pre></div>
</div>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="n">get_frequent_terms</span><span class="p">([</span><span class="n">x</span><span class="o">.</span><span class="n">all_text</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">spike_results_list_703</span><span class="p">],</span> <span class="n">stop_words</span> <span class="o">=</span> <span class="s2">&quot;english&quot;</span><span class="p">,</span> <span class="n">ngram_range</span> <span class="o">=</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span>
</pre></div>
</div>
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>count</th>
    </tr>
    <tr>
      <th>token</th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>boston airport</th>
      <td>133</td>
    </tr>
    <tr>
      <th>near boston</th>
      <td>84</td>
    </tr>
    <tr>
      <th>near boston airport</th>
      <td>77</td>
    </tr>
    <tr>
      <th>logan airport</th>
      <td>69</td>
    </tr>
    <tr>
      <th>pedestrians near</th>
      <td>57</td>
    </tr>
    <tr>
      <th>airport injured</th>
      <td>52</td>
    </tr>
    <tr>
      <th>vehicle near boston</th>
      <td>52</td>
    </tr>
    <tr>
      <th>vehicle near</th>
      <td>52</td>
    </tr>
    <tr>
      <th>pedestrians struck</th>
      <td>50</td>
    </tr>
    <tr>
      <th>pedestrians struck vehicle</th>
      <td>50</td>
    </tr>
    <tr>
      <th>struck vehicle</th>
      <td>50</td>
    </tr>
    <tr>
      <th>struck vehicle near</th>
      <td>50</td>
    </tr>
    <tr>
      <th>boston airport injured</th>
      <td>44</td>
    </tr>
    <tr>
      <th>international airport</th>
      <td>35</td>
    </tr>
    <tr>
      <th>boston's logan</th>
      <td>34</td>
    </tr>
    <tr>
      <th>boston's logan airport</th>
      <td>33</td>
    </tr>
    <tr>
      <th>people injured</th>
      <td>32</td>
    </tr>
    <tr>
      <th>strikes crowd</th>
      <td>31</td>
    </tr>
    <tr>
      <th>car strikes</th>
      <td>30</td>
    </tr>
    <tr>
      <th>near logan</th>
      <td>30</td>
    </tr>
  </tbody>
</table>
</div><div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="c1"># read some Tweets</span>
<span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">all_text</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">spike_results_list_703</span> <span class="k">if</span> <span class="s2">&quot;Boston&quot;</span> <span class="ow">in</span> <span class="n">x</span><span class="o">.</span><span class="n">all_text</span><span class="p">][</span><span class="mi">0</span><span class="p">:</span><span class="mi">10</span><span class="p">]</span>
</pre></div>
</div>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="p">[</span><span class="s1">&#39;#gossip Car Strikes Crowd at East Boston Airport, Multiple People Injured https://t.co/lK1EIbm9OJ&#39;</span><span class="p">,</span>
 <span class="s1">&#39;Tru Town Films Car Strikes Crowd at East Boston Airport, Multiple People Injured https://t.co/eUy8dWqXuD&#39;</span><span class="p">,</span>
 <span class="s1">&#39;Car Strikes Crowd at East Boston Airport, Multiple People Injured https://t.co/4YcPZ3QkZA&#39;</span><span class="p">,</span>
 <span class="s1">&#39;Car Strikes Crowd at East Boston Airport, Multiple People</span><span class="se">\xa0</span><span class="s1">Injured https://t.co/yyijNbPa4p&#39;</span><span class="p">,</span>
 <span class="s1">&#39;Pedestrians struck by vehicle near Boston airport, several injuries reported https://t.co/yOnQ9bGWBk #p2 #ctl https://t.co/ugVOtnwzLs</span><span class="se">\n\n</span><span class="s1">— …&#39;</span><span class="p">,</span>
 <span class="s2">&quot;The Times Picayune - Vehicle hits pedestrians near Boston&#39;s Logan Airport: report https://t.co/BpDCYg2i5R&quot;</span><span class="p">,</span>
 <span class="s1">&#39;Police: Boston airport crash injures 10 pedestrians https://t.co/YlGlcHFd8u&#39;</span><span class="p">,</span>
 <span class="s1">&#39;Update: Taxi incident near Boston airport being treated as accident, not terrorism, law enforcement sources say https://t.co/kgvXLkd4Zk&#39;</span><span class="p">,</span>
 <span class="s1">&#39;Car Strikes Crowd at East Boston Airport, Multiple People Injured https://t.co/PfJ7xhgPLT&#39;</span><span class="p">,</span>
 <span class="s1">&#39;Taxi strikes pedestrians near Boston airport, police</span><span class="se">\xa0</span><span class="s1">say https://t.co/gKwp3D5sA9&#39;</span><span class="p">]</span>
</pre></div>
</div>
<p>We don&#8217;t want to eliminate all mentions of &#8220;Boston Airport&#8221; (because
many of those mentions are likely relevant to my study). Instead, we&#8217;ll
eliminate a few common phrases like &#8220;pedestrians struck&#8221;, &#8220;pedestrians
injured&#8221;, &#8220;car strikes&#8221;, &#8220;taxi strikes&#8221;.</p>
<p>Add:
<code class="docutils literal"><span class="pre">-&quot;pedestrians</span> <span class="pre">struck&quot;</span> <span class="pre">-&quot;pedestrians</span> <span class="pre">injured&quot;</span> <span class="pre">-&quot;car</span> <span class="pre">strikes&quot;</span> <span class="pre">-&quot;taxi</span> <span class="pre">strikes&quot;</span> <span class="pre">-&quot;car</span> <span class="pre">hits&quot;</span></code></p>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="c1"># expand based on what you see</span>
<span class="n">_rule_e</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">(plane OR landed OR airport OR takeoff OR #wheelsup)</span>
<span class="s2">-is:retweet</span>
<span class="s2">-trump</span>
<span class="s2">-harry</span>
<span class="s2">-drowned</span>
<span class="s2">-g20</span>
<span class="s2">-lawyer</span>
<span class="s2">-gimpo</span>
<span class="s2">-fuck</span>
<span class="s2">-&quot;plane crash&quot;</span>
<span class="s2">-#gameinsight</span>
<span class="s2">-&quot;citizens of east hampton&quot;</span>
<span class="s2">-url:nytimes -url:bbc -url:washingtonpost -url:cbsnews -url:reuters -url:apnews -url:news</span>
<span class="s2">-&quot;pedestrians struck&quot; -&quot;pedestrians injured&quot; -&quot;car strikes&quot; -&quot;taxi strikes&quot; -&quot;car hits&quot;</span>
<span class="s2">&quot;&quot;&quot;</span>

<span class="n">rule_e</span> <span class="o">=</span> <span class="n">gen_rule_payload</span><span class="p">(</span><span class="n">_rule_e</span><span class="p">,</span>
                        <span class="n">from_date</span><span class="o">=</span><span class="s2">&quot;2017-07-01&quot;</span><span class="p">,</span>
                        <span class="n">to_date</span><span class="o">=</span><span class="s2">&quot;2017-08-01&quot;</span><span class="p">,</span>
                        <span class="p">)</span>

<span class="n">results_list</span> <span class="o">=</span> <span class="n">collect_results</span><span class="p">(</span><span class="n">rule_e</span><span class="p">,</span> <span class="n">max_results</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span> <span class="n">result_stream_args</span><span class="o">=</span><span class="n">search_args</span><span class="p">)</span>
</pre></div>
</div>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Recall, our new rule is: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">_rule_e</span><span class="p">))</span>
<span class="n">count_rule_e</span> <span class="o">=</span> <span class="n">gen_rule_payload</span><span class="p">(</span><span class="n">_rule_e</span><span class="p">,</span>
                        <span class="n">from_date</span><span class="o">=</span><span class="s2">&quot;2017-07-01&quot;</span><span class="p">,</span>
                        <span class="n">to_date</span><span class="o">=</span><span class="s2">&quot;2017-08-01&quot;</span><span class="p">,</span>
                        <span class="n">count_bucket</span><span class="o">=</span><span class="s2">&quot;hour&quot;</span><span class="p">)</span>

<span class="n">counts_list</span> <span class="o">=</span> <span class="n">collect_results</span><span class="p">(</span><span class="n">count_rule_e</span><span class="p">,</span> <span class="n">max_results</span><span class="o">=</span><span class="mi">24</span><span class="o">*</span><span class="mi">31</span><span class="p">,</span> <span class="n">result_stream_args</span><span class="o">=</span><span class="n">search_args</span><span class="p">)</span>

<span class="c1"># plot a timeseries of the Tweet counts</span>
<span class="n">tweet_counts</span> <span class="o">=</span> <span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">counts_list</span><span class="p">)</span>
     <span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">time_bucket</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="s2">&quot;timePeriod&quot;</span><span class="p">]))</span>
     <span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s2">&quot;timePeriod&quot;</span><span class="p">,</span><span class="n">axis</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span>
     <span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s2">&quot;time_bucket&quot;</span><span class="p">)</span>
     <span class="o">.</span><span class="n">sort_index</span><span class="p">()</span>
<span class="p">)</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">nrows</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span> <span class="o">=</span> <span class="p">(</span><span class="mi">15</span><span class="p">,</span><span class="mi">5</span><span class="p">))</span>
<span class="n">_</span> <span class="o">=</span> <span class="n">tweet_counts</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">title</span> <span class="o">=</span> <span class="s2">&quot;Count of Tweets per hour&quot;</span><span class="p">,</span> <span class="n">legend</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span>
<span class="n">_</span> <span class="o">=</span> <span class="n">tweet_counts</span><span class="o">.</span><span class="n">resample</span><span class="p">(</span><span class="s2">&quot;D&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">title</span> <span class="o">=</span> <span class="s2">&quot;Count of Tweets per day&quot;</span><span class="p">,</span> <span class="n">legend</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">Recall</span><span class="p">,</span> <span class="n">our</span> <span class="n">new</span> <span class="n">rule</span> <span class="ow">is</span><span class="p">:</span>
<span class="p">(</span><span class="n">plane</span> <span class="n">OR</span> <span class="n">landed</span> <span class="n">OR</span> <span class="n">airport</span> <span class="n">OR</span> <span class="n">takeoff</span> <span class="n">OR</span> <span class="c1">#wheelsup)</span>
<span class="o">-</span><span class="ow">is</span><span class="p">:</span><span class="n">retweet</span>
<span class="o">-</span><span class="n">trump</span>
<span class="o">-</span><span class="n">harry</span>
<span class="o">-</span><span class="n">drowned</span>
<span class="o">-</span><span class="n">g20</span>
<span class="o">-</span><span class="n">lawyer</span>
<span class="o">-</span><span class="n">gimpo</span>
<span class="o">-</span><span class="n">fuck</span>
<span class="o">-</span><span class="s2">&quot;plane crash&quot;</span>
<span class="o">-</span><span class="c1">#gameinsight</span>
<span class="o">-</span><span class="s2">&quot;citizens of east hampton&quot;</span>
<span class="o">-</span><span class="n">url</span><span class="p">:</span><span class="n">nytimes</span> <span class="o">-</span><span class="n">url</span><span class="p">:</span><span class="n">bbc</span> <span class="o">-</span><span class="n">url</span><span class="p">:</span><span class="n">washingtonpost</span> <span class="o">-</span><span class="n">url</span><span class="p">:</span><span class="n">cbsnews</span> <span class="o">-</span><span class="n">url</span><span class="p">:</span><span class="n">reuters</span> <span class="o">-</span><span class="n">url</span><span class="p">:</span><span class="n">apnews</span> <span class="o">-</span><span class="n">url</span><span class="p">:</span><span class="n">news</span>
<span class="o">-</span><span class="s2">&quot;pedestrians struck&quot;</span> <span class="o">-</span><span class="s2">&quot;pedestrians injured&quot;</span> <span class="o">-</span><span class="s2">&quot;car strikes&quot;</span> <span class="o">-</span><span class="s2">&quot;taxi strikes&quot;</span> <span class="o">-</span><span class="s2">&quot;car hits&quot;</span>
</pre></div>
</div>
<img alt="_images/finding_the_right_data_87_1.png" src="_images/finding_the_right_data_87_1.png" />
</div>
<div class="section" id="look-how-much-irrelevant-data-we-ve-eliminated">
<h2>Look how much irrelevant data we&#8217;ve eliminated<a class="headerlink" href="#look-how-much-irrelevant-data-we-ve-eliminated" title="Permalink to this headline">¶</a></h2>
<p>Let&#8217;s compare the volume of our first (unrefined) rule to our most
recent one.</p>
<p>Spoiler: We&#8217;ve eliminated a huge amount of unhelpful data!</p>
<p>Now you can begin to think about using this data in an analysis.</p>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">nrows</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span> <span class="o">=</span> <span class="p">(</span><span class="mi">15</span><span class="p">,</span><span class="mi">5</span><span class="p">))</span>
<span class="n">tweet_counts_original</span><span class="o">.</span><span class="n">resample</span><span class="p">(</span><span class="s2">&quot;D&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">axes</span><span class="p">,</span> <span class="n">title</span> <span class="o">=</span> <span class="s2">&quot;Count of Tweets per day&quot;</span><span class="p">,</span> <span class="n">legend</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span>
<span class="n">tweet_counts</span><span class="o">.</span><span class="n">resample</span><span class="p">(</span><span class="s2">&quot;D&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">axes</span><span class="p">,</span> <span class="n">title</span> <span class="o">=</span> <span class="s2">&quot;Count of Tweets per day&quot;</span><span class="p">,</span> <span class="n">legend</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">([</span><span class="s2">&quot;original&quot;</span><span class="p">,</span> <span class="s2">&quot;refined&quot;</span><span class="p">]);</span>
</pre></div>
</div>
<img alt="_images/finding_the_right_data_89_0.png" src="_images/finding_the_right_data_89_0.png" />
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="n">get_frequent_terms</span><span class="p">([</span><span class="n">x</span><span class="o">.</span><span class="n">all_text</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">results_list</span><span class="p">],</span> <span class="n">stop_words</span> <span class="o">=</span> <span class="s2">&quot;english&quot;</span><span class="p">,</span> <span class="n">ngram_range</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span>
</pre></div>
</div>
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>count</th>
    </tr>
    <tr>
      <th>token</th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>airport</th>
      <td>247</td>
    </tr>
    <tr>
      <th>plane</th>
      <td>173</td>
    </tr>
    <tr>
      <th>landed</th>
      <td>64</td>
    </tr>
    <tr>
      <th>i'm</th>
      <td>36</td>
    </tr>
    <tr>
      <th>just</th>
      <td>35</td>
    </tr>
    <tr>
      <th>international</th>
      <td>32</td>
    </tr>
    <tr>
      <th>international airport</th>
      <td>30</td>
    </tr>
    <tr>
      <th>people</th>
      <td>21</td>
    </tr>
    <tr>
      <th>like</th>
      <td>21</td>
    </tr>
    <tr>
      <th>time</th>
      <td>18</td>
    </tr>
    <tr>
      <th>don't</th>
      <td>17</td>
    </tr>
    <tr>
      <th>security</th>
      <td>17</td>
    </tr>
    <tr>
      <th>flight</th>
      <td>16</td>
    </tr>
    <tr>
      <th>takeoff</th>
      <td>15</td>
    </tr>
    <tr>
      <th>got</th>
      <td>14</td>
    </tr>
    <tr>
      <th>passenger</th>
      <td>14</td>
    </tr>
    <tr>
      <th>today</th>
      <td>13</td>
    </tr>
    <tr>
      <th>know</th>
      <td>13</td>
    </tr>
    <tr>
      <th>hours</th>
      <td>12</td>
    </tr>
    <tr>
      <th>just landed</th>
      <td>12</td>
    </tr>
  </tbody>
</table>
</div></div>
<div class="section" id="pulling-our-dataset">
<h2>Pulling our dataset<a class="headerlink" href="#pulling-our-dataset" title="Permalink to this headline">¶</a></h2>
<p>It&#8217;s always possible to continue refining a dataset, and we should
definitely continue that work after pulling the Tweets. The key in early
data-cleaning steps is to eliminate a large bulk of irrelevant Tweets
that you don&#8217;t want to store or pay for (we did that).</p>
<p>Now (<strong>warning!</strong> this will use quite a few API calls and you might want
to think twice before actually running it. The cell type is markdown so
you can&#8217;t run it on accident) let&#8217;s pull data with our final rule.</p>
<p>Before you decide to pull this data, we&#8217;ll check how many API calls
we&#8217;ve used in this notebook (the <code class="docutils literal"><span class="pre">ResultStream</span></code> object provides a
convenience variable for this).</p>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="c1"># count API calls</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;You have used </span><span class="si">{}</span><span class="s2"> API calls in this session&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ResultStream</span><span class="o">.</span><span class="n">session_request_counter</span><span class="p">))</span>
</pre></div>
</div>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">You</span> <span class="n">have</span> <span class="n">used</span> <span class="mi">12</span> <span class="n">API</span> <span class="n">calls</span> <span class="ow">in</span> <span class="n">this</span> <span class="n">session</span>
</pre></div>
</div>
<p><strong>Store the data you pull!</strong></p>
<p>You don&#8217;t want to pull this much data without saving it for later. We&#8217;re
going to use the <code class="docutils literal"><span class="pre">ResultStream</span></code> object to make API calls, stream data
in an iterator, hold relevant data information in memory in my Python
session, and (importantly!) stream raw Tweets to a file for later use.</p>
<p>Even if you don&#8217;t want to run these exact API calls, pay attention to
how this is done for your own work.</p>
<p><strong>Finalize your rule</strong></p>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="c1"># this is our final rule</span>
<span class="nb">print</span><span class="p">(</span><span class="n">_rule_e</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="p">(</span><span class="n">plane</span> <span class="n">OR</span> <span class="n">landed</span> <span class="n">OR</span> <span class="n">airport</span> <span class="n">OR</span> <span class="n">takeoff</span> <span class="n">OR</span> <span class="c1">#wheelsup)</span>
<span class="o">-</span><span class="ow">is</span><span class="p">:</span><span class="n">retweet</span>
<span class="o">-</span><span class="n">trump</span>
<span class="o">-</span><span class="n">harry</span>
<span class="o">-</span><span class="n">drowned</span>
<span class="o">-</span><span class="n">g20</span>
<span class="o">-</span><span class="n">lawyer</span>
<span class="o">-</span><span class="n">gimpo</span>
<span class="o">-</span><span class="n">fuck</span>
<span class="o">-</span><span class="s2">&quot;plane crash&quot;</span>
<span class="o">-</span><span class="c1">#gameinsight</span>
<span class="o">-</span><span class="s2">&quot;citizens of east hampton&quot;</span>
<span class="o">-</span><span class="n">url</span><span class="p">:</span><span class="n">nytimes</span> <span class="o">-</span><span class="n">url</span><span class="p">:</span><span class="n">bbc</span> <span class="o">-</span><span class="n">url</span><span class="p">:</span><span class="n">washingtonpost</span> <span class="o">-</span><span class="n">url</span><span class="p">:</span><span class="n">cbsnews</span> <span class="o">-</span><span class="n">url</span><span class="p">:</span><span class="n">reuters</span> <span class="o">-</span><span class="n">url</span><span class="p">:</span><span class="n">apnews</span> <span class="o">-</span><span class="n">url</span><span class="p">:</span><span class="n">news</span>
<span class="o">-</span><span class="s2">&quot;pedestrians struck&quot;</span> <span class="o">-</span><span class="s2">&quot;pedestrians injured&quot;</span> <span class="o">-</span><span class="s2">&quot;car strikes&quot;</span> <span class="o">-</span><span class="s2">&quot;taxi strikes&quot;</span> <span class="o">-</span><span class="s2">&quot;car hits&quot;</span>
</pre></div>
</div>
<div class="line-block">
<div class="line"><strong>No surprises</strong></div>
<div class="line">You should always have a guess at how many Tweets you&#8217;re going to pull
<em>before</em> you pull them. Use the Counts API (if possible), or
extrapolate based on a smaller time period of data.</div>
</div>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="c1"># I can sum up the counts endpoint results to guess how may Tweets I&#39;ll get</span>
<span class="c1"># (or, if you don&#39;t have access to the counts endpoints, try extrapolating from a single day)</span>
<span class="n">tweet_counts</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
</pre></div>
</div>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">count</span>    <span class="mi">1572126</span>
<span class="n">dtype</span><span class="p">:</span> <span class="n">int64</span>
</pre></div>
</div>
<p><strong>Narrowing your dataset further</strong></p>
<p>You might refine your rule and find that there are still millions of
Tweets about a topic on Twitter (this happens, there are lots of
Tweets).</p>
<p>If your rule is still going to pull an unrealistic number of Tweets,
maybe narrow the scope of your investigation. You can: - <strong>Narrow the
time period</strong>: do you really need a month of data? or maybe you could
sample just a few days? - <strong>Select more specific Tweets</strong>: maybe it
would be helpful to your analysis to have only Tweets that are geo
tagged (this reduces data volume significantly)? Or only pull Tweets
from users with profile locations? Putting stringent requirements on
data can help speed up your analysis and make your data volume smaller.
- <strong>Sampling</strong>: Search API doesn&#8217;t support random sampling the way that
the Historical APIs do. You&#8217;ll have to come up with balanced ways of
selecting for less data, or you can sample based on geography, time,
Tweet language&#8211;anything to narrow your scope.</p>
<p>I&#8217;m going to show one example of this by <em>only</em> pulling Tweets from
users with a profile location (you can read up more on what a &#8220;profile
location&#8221; means in our documentation) in the state of Colorado (this is
for illustrative purposes, depending on your use case, we&#8217;d probably
recommend narrowing the time scope first).</p>
<p>Add: <code class="docutils literal"><span class="pre">profile_country:US</span> <span class="pre">profile_region:Colorado</span></code> to my Twitter Search
rule.</p>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="n">final_rule</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">(plane OR landed OR airport OR takeoff OR #wheelsup)</span>
<span class="s2">-is:retweet</span>
<span class="s2">-trump</span>
<span class="s2">-harry</span>
<span class="s2">-drowned</span>
<span class="s2">-g20</span>
<span class="s2">-lawyer</span>
<span class="s2">-gimpo</span>
<span class="s2">-fuck</span>
<span class="s2">-&quot;plane crash&quot;</span>
<span class="s2">-#gameinsight</span>
<span class="s2">-&quot;citizens of east hampton&quot;</span>
<span class="s2">-url:nytimes -url:bbc -url:washingtonpost -url:cbsnews -url:reuters -url:apnews -url:news</span>
<span class="s2">-&quot;pedestrians struck&quot; -&quot;pedstrians injured&quot; -&quot;car strikes&quot; -&quot;taxi strikes&quot; -&quot;car hits&quot;</span>
<span class="s2">profile_country:US profile_region:&quot;Colorado&quot;</span>
<span class="s2">&quot;&quot;&quot;</span>

<span class="n">count_rule</span> <span class="o">=</span> <span class="n">gen_rule_payload</span><span class="p">(</span><span class="n">final_rule</span><span class="p">,</span>
                        <span class="n">from_date</span><span class="o">=</span><span class="s2">&quot;2017-07-01&quot;</span><span class="p">,</span>
                        <span class="n">to_date</span><span class="o">=</span><span class="s2">&quot;2017-08-01&quot;</span><span class="p">,</span>
                        <span class="n">count_bucket</span><span class="o">=</span><span class="s2">&quot;hour&quot;</span><span class="p">)</span>

<span class="n">counts_list</span> <span class="o">=</span> <span class="n">collect_results</span><span class="p">(</span><span class="n">count_rule</span><span class="p">,</span> <span class="n">max_results</span><span class="o">=</span><span class="mi">24</span><span class="o">*</span><span class="mi">31</span><span class="p">,</span> <span class="n">result_stream_args</span><span class="o">=</span><span class="n">search_args</span><span class="p">)</span>

<span class="c1"># plot a timeseries of the Tweet counts</span>
<span class="n">tweet_counts</span> <span class="o">=</span> <span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">counts_list</span><span class="p">)</span>
     <span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">time_bucket</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="s2">&quot;timePeriod&quot;</span><span class="p">]))</span>
     <span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s2">&quot;timePeriod&quot;</span><span class="p">,</span><span class="n">axis</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span>
     <span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s2">&quot;time_bucket&quot;</span><span class="p">)</span>
     <span class="o">.</span><span class="n">sort_index</span><span class="p">()</span>
<span class="p">)</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">nrows</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span> <span class="o">=</span> <span class="p">(</span><span class="mi">15</span><span class="p">,</span><span class="mi">5</span><span class="p">))</span>
<span class="n">_</span> <span class="o">=</span> <span class="n">tweet_counts</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">title</span> <span class="o">=</span> <span class="s2">&quot;Count of Tweets per hour&quot;</span><span class="p">,</span> <span class="n">legend</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span>
<span class="n">_</span> <span class="o">=</span> <span class="n">tweet_counts</span><span class="o">.</span><span class="n">resample</span><span class="p">(</span><span class="s2">&quot;D&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">title</span> <span class="o">=</span> <span class="s2">&quot;Count of Tweets per day&quot;</span><span class="p">,</span> <span class="n">legend</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span>
</pre></div>
</div>
<img alt="_images/finding_the_right_data_99_0.png" src="_images/finding_the_right_data_99_0.png" />
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="n">tweet_counts</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
</pre></div>
</div>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">count</span>    <span class="mi">7225</span>
<span class="n">dtype</span><span class="p">:</span> <span class="n">int64</span>
</pre></div>
</div>
</div>
<div class="section" id="save-tweets-to-a-file-and-stream-them-into-memory">
<h2>Save Tweets to a file, and stream them into memory<a class="headerlink" href="#save-tweets-to-a-file-and-stream-them-into-memory" title="Permalink to this headline">¶</a></h2>
<p>Seems like a reasonable number of Tweets. Let&#8217;s go get them.</p>
<p>This time, we&#8217;re going to use the ResultStream object and stream the
full Tweet payloads to a file while simultaneously creating a Pandas
DataFrame in memory of the limited Tweet fields that we care about.</p>
<p>If you actually want to run the cell below, you&#8217;ll have to set the cell
type to &#8220;code.&#8221;</p>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="n">final_rule_payload</span> <span class="o">=</span> <span class="n">gen_rule_payload</span><span class="p">(</span><span class="n">final_rule</span><span class="p">,</span>
                                      <span class="n">from_date</span><span class="o">=</span><span class="s2">&quot;2017-07-01&quot;</span><span class="p">,</span>
                                      <span class="n">to_date</span><span class="o">=</span><span class="s2">&quot;2017-08-01&quot;</span><span class="p">)</span>

<span class="n">stream</span> <span class="o">=</span> <span class="n">ResultStream</span><span class="p">(</span><span class="o">**</span><span class="n">search_args</span><span class="p">,</span>
                       <span class="n">rule_payload</span><span class="o">=</span><span class="n">final_rule_payload</span><span class="p">,</span>
                       <span class="n">max_results</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span> <span class="c1"># should collect all of the results</span>

<span class="c1"># write_ndjson is a utility function that writes the results to a file and passes them through the iterator</span>
<span class="kn">from</span> <span class="nn">searchtweets.utils</span> <span class="k">import</span> <span class="n">write_ndjson</span>

<span class="n">limited_fields</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">write_ndjson</span><span class="p">(</span><span class="s2">&quot;air_travel_data.json&quot;</span><span class="p">,</span> <span class="n">stream</span><span class="o">.</span><span class="n">stream</span><span class="p">()):</span>
    <span class="n">limited_fields</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">&quot;date&quot;</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">created_at_datetime</span><span class="p">,</span>
                           <span class="s2">&quot;text&quot;</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">all_text</span><span class="p">,</span>
                           <span class="s2">&quot;user&quot;</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">screen_name</span><span class="p">,</span>
                           <span class="s2">&quot;bio&quot;</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">bio</span><span class="p">,</span>
                           <span class="s2">&quot;at_mentions&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">u</span><span class="p">[</span><span class="s2">&quot;screen_name&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">u</span> <span class="ow">in</span> <span class="n">x</span><span class="o">.</span><span class="n">user_mentions</span><span class="p">],</span>
                           <span class="s2">&quot;hashtags&quot;</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">hashtags</span><span class="p">,</span>
                           <span class="s2">&quot;urls&quot;</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">most_unrolled_urls</span><span class="p">,</span>
                           <span class="s2">&quot;geo&quot;</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">geo_coordinates</span><span class="p">,</span>
                           <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">tweet_type</span><span class="p">,</span>
                           <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">id</span><span class="p">})</span>
<span class="c1"># create a dataframe</span>
<span class="n">final_dataset_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">limited_fields</span><span class="p">)</span>
<span class="n">final_dataset_df</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="conclusion">
<h1>Conclusion<a class="headerlink" href="#conclusion" title="Permalink to this headline">¶</a></h1>
<p>All Tweet data collection should be focused on a question, and our
focused on finding out what people were talking about while they flew on
airplanes. You can use the same basic steps that we used here to answer
your own business questions using Twitter data.</p>
<ol class="arabic simple">
<li>Consume Tweet data<ul>
<li>We walked through how to access the Search API using the
<code class="docutils literal"><span class="pre">searchtweets</span></code>
<a class="reference external" href="https://github.com/twitterdev/search-tweets-python">package</a>
and how to write rules to get the Tweets that you are looking for.</li>
</ul>
</li>
<li>Parse Twitter data<ul>
<li>We talked about the JSON Tweet payloads, <code class="docutils literal"><span class="pre">Tweet</span></code> objects
(provided by the <code class="docutils literal"><span class="pre">tweet_parser</span></code>
<a class="reference external" href="https://github.com/twitterdev/tweet_parser">package</a>), and
Tweet <a class="reference external" href="https://developer.twitter.com/en/docs/tweets/data-dictionary/overview/intro-to-tweet-json">payload
elements</a>.</li>
</ul>
</li>
<li>Describe Twitter data<ul>
<li>We talked about how to describe data, using frequent terms, top
users, timeseries spikes, and Twitter elements like hashtags and
links.</li>
</ul>
</li>
<li>Iterate on your search terms to filter the data<ul>
<li>We talked about how to narrow down a search by negating irrelevant
terms, narrowing the time or the area of your search, and
iterating until you retrieve a reasonable number of Tweets.</li>
</ul>
</li>
</ol>
</div>


    </div>
      
  </div>
</div>
    
      <!-- Global site tag (gtag.js) - Google Analytics --> <script async src="https://www.googletagmanager.com/gtag/js?id=UA-30775-108"></script> <script> window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'UA-30775-108'); </script>
      
<footer class="footer">
  <div class="container">
    <p class="pull-right">
      <a href="#">Back to top</a>
      
    </p>
    <p>
        &copy; Copyright 2018, Twitter.<br/>
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.5.6.<br/>
    </p>
  </div>
</footer>
    


  </body>
</html>